<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ”§ Vercel å®æ—¶ API è¯Šæ–­å·¥å…·</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            color: white;
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(30, 41, 59, 0.3);
            border-radius: 12px;
            border: 1px solid rgba(148, 163, 184, 0.2);
        }
        
        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .test-card {
            background: rgba(30, 41, 59, 0.3);
            border: 1px solid rgba(148, 163, 184, 0.2);
            border-radius: 12px;
            padding: 20px;
        }
        
        .test-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .test-button {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 15px;
            transition: all 0.3s ease;
            width: 100%;
        }
        
        .test-button:hover {
            background: #2563eb;
        }
        
        .test-button:disabled {
            background: #64748b;
            cursor: not-allowed;
        }
        
        .result-area {
            background: #111827;
            border: 1px solid rgba(148, 163, 184, 0.2);
            border-radius: 6px;
            padding: 15px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-break: break-all;
        }
        
        .success {
            color: #10b981;
        }
        
        .error {
            color: #ef4444;
        }
        
        .info {
            color: #60a5fa;
        }
        
        .warning {
            color: #f59e0b;
        }
        
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
        }
        
        .status-ok {
            background: #10b981;
        }
        
        .status-error {
            background: #ef4444;
        }
        
        .status-unknown {
            background: #6b7280;
        }
        
        .summary-card {
            background: rgba(59, 130, 246, 0.1);
            border: 1px solid rgba(59, 130, 246, 0.3);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .auto-test-section {
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid rgba(16, 185, 129, 0.3);
            border-radius: 12px;
            padding: 20px;
            margin-top: 30px;
        }
        
        .loading {
            opacity: 0.6;
        }
        
        .log-entry {
            margin-bottom: 8px;
            padding: 8px;
            border-radius: 4px;
            background: rgba(0, 0, 0, 0.3);
        }
        
        .timestamp {
            color: #9ca3af;
            font-size: 11px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ”§ Vercel å®æ—¶ API è¯Šæ–­å·¥å…·</h1>
            <p>ä¸“ä¸ºç”Ÿäº§ç¯å¢ƒ API 404 é—®é¢˜è®¾è®¡çš„è¯Šæ–­å·¥å…·</p>
            <p id="currentUrl" class="info"></p>
        </div>
        
        <div class="summary-card">
            <h3>ğŸ¯ å½“å‰ç¯å¢ƒçŠ¶æ€</h3>
            <div id="environmentInfo"></div>
        </div>
        
        <div class="status-grid">
            <!-- åŸºç¡€è¿é€šæ€§æµ‹è¯• -->
            <div class="test-card">
                <h3 class="test-title">
                    <span class="status-indicator status-unknown" id="basicStatus"></span>
                    ğŸŒ åŸºç¡€è¿é€šæ€§
                </h3>
                <button class="test-button" onclick="testBasicConnectivity()">æµ‹è¯•åŸºç¡€è¿é€šæ€§</button>
                <div class="result-area" id="basicResult">ç­‰å¾…æµ‹è¯•...</div>
            </div>
            
            <!-- Hello API æµ‹è¯• -->
            <div class="test-card">
                <h3 class="test-title">
                    <span class="status-indicator status-unknown" id="helloStatus"></span>
                    ğŸ‘‹ Hello API
                </h3>
                <button class="test-button" onclick="testHelloAPI()">æµ‹è¯• /api/hello</button>
                <div class="result-area" id="helloResult">ç­‰å¾…æµ‹è¯•...</div>
            </div>
            
            <!-- æ–°æµ‹è¯• API -->
            <div class="test-card">
                <h3 class="test-title">
                    <span class="status-indicator status-unknown" id="testApiStatus"></span>
                    ğŸ§ª æµ‹è¯• API
                </h3>
                <button class="test-button" onclick="testNewTestAPI()">æµ‹è¯• /api/test</button>
                <div class="result-area" id="testApiResult">ç­‰å¾…æµ‹è¯•...</div>
            </div>
            
            <!-- OpenAI API é¢„æ£€ -->
            <div class="test-card">
                <h3 class="test-title">
                    <span class="status-indicator status-unknown" id="openaiPreStatus"></span>
                    ğŸ” OpenAI API é¢„æ£€
                </h3>
                <button class="test-button" onclick="testOpenAIPrecheck()">æµ‹è¯• OPTIONS è¯·æ±‚</button>
                <div class="result-area" id="openaiPreResult">ç­‰å¾…æµ‹è¯•...</div>
            </div>
            
            <!-- OpenAI API å®Œæ•´æµ‹è¯• -->
            <div class="test-card">
                <h3 class="test-title">
                    <span class="status-indicator status-unknown" id="openaiFullStatus"></span>
                    ğŸ¤– OpenAI API å®Œæ•´æµ‹è¯•
                </h3>
                <button class="test-button" onclick="testOpenAIFull()">æµ‹è¯•å®Œæ•´è¯·æ±‚</button>
                <div class="result-area" id="openaiFullResult">ç­‰å¾…æµ‹è¯•...</div>
            </div>
            
            <!-- ç¯å¢ƒå˜é‡æ£€æŸ¥ -->
            <div class="test-card">
                <h3 class="test-title">
                    <span class="status-indicator status-unknown" id="envStatus"></span>
                    âš™ï¸ ç¯å¢ƒå˜é‡
                </h3>
                <button class="test-button" onclick="testEnvironmentVars()">æ£€æŸ¥ç¯å¢ƒå˜é‡</button>
                <div class="result-area" id="envResult">ç­‰å¾…æµ‹è¯•...</div>
            </div>
            
            <!-- ç½‘ç»œè¯Šæ–­ -->
            <div class="test-card">
                <h3 class="test-title">
                    <span class="status-indicator status-unknown" id="networkStatus"></span>
                    ğŸŒ ç½‘ç»œè¯Šæ–­
                </h3>
                <button class="test-button" onclick="testNetworkDiagnostics()">ç½‘ç»œè¿æ¥è¯Šæ–­</button>
                <div class="result-area" id="networkResult">ç­‰å¾…æµ‹è¯•...</div>
            </div>
        </div>
        
        <div class="auto-test-section">
            <h3>ğŸš€ è‡ªåŠ¨åŒ–æµ‹è¯•</h3>
            <p>ä¸€é”®è¿è¡Œæ‰€æœ‰æµ‹è¯•ï¼Œå¿«é€Ÿå®šä½é—®é¢˜</p>
            <button class="test-button" onclick="runAllTests()" id="autoTestBtn">è¿è¡Œæ‰€æœ‰æµ‹è¯•</button>
            <div class="result-area" id="autoTestResult">ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®å¼€å§‹è‡ªåŠ¨æµ‹è¯•...</div>
        </div>
    </div>

    <script>
        // æ›´æ–°å½“å‰ URL æ˜¾ç¤º
        document.getElementById('currentUrl').textContent = `å½“å‰ URL: ${window.location.href}`;
        
        // æ˜¾ç¤ºç¯å¢ƒä¿¡æ¯
        function updateEnvironmentInfo() {
            const info = {
                'ä¸»æœºå': window.location.hostname,
                'åè®®': window.location.protocol,
                'ç«¯å£': window.location.port || 'é»˜è®¤',
                'è·¯å¾„': window.location.pathname,
                'æ˜¯å¦ Vercel': window.location.hostname.includes('vercel.app') ? 'æ˜¯' : 'å¦',
                'ç”¨æˆ·ä»£ç†': navigator.userAgent.substring(0, 100) + '...',
                'æ—¶é—´æˆ³': new Date().toLocaleString()
            };
            
            let html = '';
            for (const [key, value] of Object.entries(info)) {
                html += `<div><strong>${key}:</strong> ${value}</div>`;
            }
            document.getElementById('environmentInfo').innerHTML = html;
        }
        
        updateEnvironmentInfo();
        
        // é€šç”¨çš„ç»“æœæ˜¾ç¤ºå‡½æ•°
        function showResult(elementId, content, type = 'info', statusId = null) {
            const element = document.getElementById(elementId);
            const timestamp = new Date().toLocaleTimeString();
            
            element.innerHTML = `<div class="log-entry">
                <div class="timestamp">[${timestamp}]</div>
                <div class="${type}">${content}</div>
            </div>` + element.innerHTML;
            
            // æ›´æ–°çŠ¶æ€æŒ‡ç¤ºå™¨
            if (statusId) {
                const statusEl = document.getElementById(statusId);
                statusEl.className = `status-indicator ${type === 'success' ? 'status-ok' : type === 'error' ? 'status-error' : 'status-unknown'}`;
            }
        }
        
        // æµ‹è¯•åŸºç¡€è¿é€šæ€§
        async function testBasicConnectivity() {
            showResult('basicResult', 'å¼€å§‹æµ‹è¯•åŸºç¡€è¿é€šæ€§...', 'info');
            
            try {
                const startTime = performance.now();
                const response = await fetch(window.location.origin, {
                    method: 'HEAD',
                    cache: 'no-cache'
                });
                const endTime = performance.now();
                const latency = Math.round(endTime - startTime);
                
                if (response.ok) {
                    showResult('basicResult', `âœ… åŸºç¡€è¿é€šæ€§æ­£å¸¸\nå“åº”æ—¶é—´: ${latency}ms\nçŠ¶æ€ç : ${response.status}`, 'success', 'basicStatus');
                } else {
                    showResult('basicResult', `âš ï¸ å“åº”å¼‚å¸¸\nçŠ¶æ€ç : ${response.status}\nå“åº”æ—¶é—´: ${latency}ms`, 'warning', 'basicStatus');
                }
            } catch (error) {
                showResult('basicResult', `âŒ è¿æ¥å¤±è´¥: ${error.message}`, 'error', 'basicStatus');
            }
        }
        
        // æµ‹è¯• Hello API
        async function testHelloAPI() {
            showResult('helloResult', 'æµ‹è¯• Hello API...', 'info');
            
            try {
                const response = await fetch('/api/hello', {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json' },
                    cache: 'no-cache'
                });
                
                const responseText = await response.text();
                
                if (response.ok) {
                    try {
                        const data = JSON.parse(responseText);
                        showResult('helloResult', `âœ… Hello API æ­£å¸¸å·¥ä½œ\nå“åº”: ${JSON.stringify(data, null, 2)}`, 'success', 'helloStatus');
                    } catch (e) {
                        showResult('helloResult', `âœ… Hello API å“åº”æˆåŠŸ\nåŸå§‹å“åº”: ${responseText}`, 'success', 'helloStatus');
                    }
                } else {
                    showResult('helloResult', `âŒ Hello API å¤±è´¥\nçŠ¶æ€: ${response.status} ${response.statusText}\nå“åº”: ${responseText}`, 'error', 'helloStatus');
                }
            } catch (error) {
                showResult('helloResult', `âŒ Hello API è¯·æ±‚å¤±è´¥: ${error.message}`, 'error', 'helloStatus');
            }
        }
        
        // æµ‹è¯•æ–°çš„æµ‹è¯• API ç«¯ç‚¹
        async function testNewTestAPI() {
            showResult('testApiResult', 'æµ‹è¯•æ–°çš„æµ‹è¯•APIç«¯ç‚¹...', 'info');
            
            try {
                const response = await fetch('/api/test', {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json' },
                    cache: 'no-cache'
                });
                
                const responseText = await response.text();
                
                if (response.ok) {
                    try {
                        const data = JSON.parse(responseText);
                        showResult('testApiResult', `âœ… æµ‹è¯•API æ­£å¸¸å·¥ä½œ\nå“åº”: ${JSON.stringify(data, null, 2)}`, 'success', 'testApiStatus');
                    } catch (e) {
                        showResult('testApiResult', `âœ… æµ‹è¯•API å“åº”æˆåŠŸ\nåŸå§‹å“åº”: ${responseText}`, 'success', 'testApiStatus');
                    }
                } else {
                    showResult('testApiResult', `âŒ æµ‹è¯•API å¤±è´¥\nçŠ¶æ€: ${response.status} ${response.statusText}\nå“åº”: ${responseText}`, 'error', 'testApiStatus');
                }
            } catch (error) {
                showResult('testApiResult', `âŒ æµ‹è¯•API è¯·æ±‚å¤±è´¥: ${error.message}`, 'error', 'testApiStatus');
            }
        }
        
        // æµ‹è¯• OpenAI API é¢„æ£€
        async function testOpenAIPrecheck() {
            showResult('openaiPreResult', 'æµ‹è¯• OpenAI API OPTIONS è¯·æ±‚...', 'info');
            
            try {
                const response = await fetch('/api/openai', {
                    method: 'OPTIONS',
                    headers: { 'Content-Type': 'application/json' },
                    cache: 'no-cache'
                });
                
                const headers = {};
                response.headers.forEach((value, key) => headers[key] = value);
                
                if (response.ok) {
                    showResult('openaiPreResult', `âœ… OpenAI API é¢„æ£€é€šè¿‡\nçŠ¶æ€: ${response.status}\nCORS å¤´: ${JSON.stringify(headers, null, 2)}`, 'success', 'openaiPreStatus');
                } else {
                    showResult('openaiPreResult', `âš ï¸ OpenAI API é¢„æ£€å¼‚å¸¸\nçŠ¶æ€: ${response.status} ${response.statusText}\nå¤´ä¿¡æ¯: ${JSON.stringify(headers, null, 2)}`, 'warning', 'openaiPreStatus');
                }
            } catch (error) {
                showResult('openaiPreResult', `âŒ OpenAI API é¢„æ£€å¤±è´¥: ${error.message}`, 'error', 'openaiPreStatus');
            }
        }
        
        // æµ‹è¯• OpenAI API å®Œæ•´è¯·æ±‚
        async function testOpenAIFull() {
            showResult('openaiFullResult', 'æµ‹è¯• OpenAI API å®Œæ•´è¯·æ±‚...', 'info');
            
            try {
                const testData = {
                    userInput: "æµ‹è¯•è¾“å…¥ï¼šå±•ç¤ºæˆ‘ä»¬å…¬å¸çš„æ ¸å¿ƒä»·å€¼è§‚",
                    componentType: "core-value",
                    prompt: "è¯·ç”Ÿæˆä¸€ä¸ªç®€å•çš„æ ¸å¿ƒä»·å€¼è§‚åˆ—è¡¨æµ‹è¯•æ•°æ®"
                };
                
                const response = await fetch('/api/openai', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(testData),
                    cache: 'no-cache'
                });
                
                const responseText = await response.text();
                
                if (response.ok) {
                    try {
                        const data = JSON.parse(responseText);
                        showResult('openaiFullResult', `âœ… OpenAI API å®Œæ•´æµ‹è¯•æˆåŠŸ\nå“åº”æ•°æ®: ${JSON.stringify(data, null, 2)}`, 'success', 'openaiFullStatus');
                    } catch (e) {
                        showResult('openaiFullResult', `âš ï¸ OpenAI API å“åº”æ ¼å¼å¼‚å¸¸\nåŸå§‹å“åº”: ${responseText}`, 'warning', 'openaiFullStatus');
                    }
                } else {
                    showResult('openaiFullResult', `âŒ OpenAI API å®Œæ•´æµ‹è¯•å¤±è´¥\nçŠ¶æ€: ${response.status} ${response.statusText}\nå“åº”: ${responseText}`, 'error', 'openaiFullStatus');
                }
            } catch (error) {
                showResult('openaiFullResult', `âŒ OpenAI API å®Œæ•´è¯·æ±‚å¤±è´¥: ${error.message}`, 'error', 'openaiFullStatus');
            }
        }
        
        // æµ‹è¯•ç¯å¢ƒå˜é‡
        async function testEnvironmentVars() {
            showResult('envResult', 'æ£€æŸ¥ç¯å¢ƒå˜é‡...', 'info');
            
            try {
                const response = await fetch('/api/check-env', {
                    method: 'GET',
                    cache: 'no-cache'
                });
                
                const responseText = await response.text();
                
                if (response.ok) {
                    try {
                        const data = JSON.parse(responseText);
                        showResult('envResult', `âœ… ç¯å¢ƒå˜é‡æ£€æŸ¥å®Œæˆ\nç»“æœ: ${JSON.stringify(data, null, 2)}`, 'success', 'envStatus');
                    } catch (e) {
                        showResult('envResult', `âš ï¸ ç¯å¢ƒå˜é‡ API å“åº”æ ¼å¼å¼‚å¸¸\nåŸå§‹å“åº”: ${responseText}`, 'warning', 'envStatus');
                    }
                } else {
                    showResult('envResult', `âŒ ç¯å¢ƒå˜é‡æ£€æŸ¥å¤±è´¥\nçŠ¶æ€: ${response.status} ${response.statusText}\nå“åº”: ${responseText}`, 'error', 'envStatus');
                }
            } catch (error) {
                showResult('envResult', `âŒ ç¯å¢ƒå˜é‡æ£€æŸ¥è¯·æ±‚å¤±è´¥: ${error.message}`, 'error', 'envStatus');
            }
        }
        
        // ç½‘ç»œè¯Šæ–­
        async function testNetworkDiagnostics() {
            showResult('networkResult', 'è¿›è¡Œç½‘ç»œè¯Šæ–­...', 'info');
            
            const diagnostics = {
                'DNSè§£æ': await testDNS(),
                'CDNå¯è¾¾æ€§': await testCDN(),
                'æµè§ˆå™¨ä¿¡æ¯': getBrowserInfo()
            };
            
            showResult('networkResult', `ğŸŒ ç½‘ç»œè¯Šæ–­å®Œæˆ\n${JSON.stringify(diagnostics, null, 2)}`, 'info', 'networkStatus');
        }
        
        async function testDNS() {
            try {
                const start = performance.now();
                await fetch('https://1.1.1.1/', { method: 'HEAD', mode: 'no-cors' });
                const end = performance.now();
                return `æ­£å¸¸ (${Math.round(end - start)}ms)`;
            } catch (e) {
                return `å¼‚å¸¸: ${e.message}`;
            }
        }
        
        async function testCDN() {
            try {
                const start = performance.now();
                await fetch('https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js', { method: 'HEAD' });
                const end = performance.now();
                return `æ­£å¸¸ (${Math.round(end - start)}ms)`;
            } catch (e) {
                return `å¼‚å¸¸: ${e.message}`;
            }
        }
        
        function getBrowserInfo() {
            return {
                'æµè§ˆå™¨': navigator.userAgent.match(/(Chrome|Firefox|Safari|Edge)\/[\d.]+/)?.[0] || 'æœªçŸ¥',
                'å¹³å°': navigator.platform,
                'è¯­è¨€': navigator.language,
                'åœ¨çº¿çŠ¶æ€': navigator.onLine ? 'åœ¨çº¿' : 'ç¦»çº¿'
            };
        }
        
        // è¿è¡Œæ‰€æœ‰æµ‹è¯•
        async function runAllTests() {
            const btn = document.getElementById('autoTestBtn');
            btn.disabled = true;
            btn.textContent = 'æ­£åœ¨è¿è¡Œæµ‹è¯•...';
            
            showResult('autoTestResult', 'ğŸš€ å¼€å§‹è‡ªåŠ¨åŒ–æµ‹è¯•...', 'info');
            
            const tests = [
                { name: 'åŸºç¡€è¿é€šæ€§', func: testBasicConnectivity },
                { name: 'Hello API', func: testHelloAPI },
                { name: 'OpenAI é¢„æ£€', func: testOpenAIPrecheck },
                { name: 'OpenAI å®Œæ•´æµ‹è¯•', func: testOpenAIFull },
                { name: 'ç¯å¢ƒå˜é‡', func: testEnvironmentVars },
                { name: 'ç½‘ç»œè¯Šæ–­', func: testNetworkDiagnostics }
            ];
            
            for (const test of tests) {
                showResult('autoTestResult', `æ­£åœ¨æ‰§è¡Œ: ${test.name}...`, 'info');
                await test.func();
                await new Promise(resolve => setTimeout(resolve, 1000)); // é—´éš”1ç§’
            }
            
            showResult('autoTestResult', 'âœ… æ‰€æœ‰æµ‹è¯•å®Œæˆï¼è¯·æŸ¥çœ‹å„ä¸ªæµ‹è¯•å¡ç‰‡çš„è¯¦ç»†ç»“æœã€‚', 'success');
            
            btn.disabled = false;
            btn.textContent = 'é‡æ–°è¿è¡Œæ‰€æœ‰æµ‹è¯•';
        }
        
        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ£€æŸ¥åŸºç¡€çŠ¶æ€
        window.onload = function() {
            setTimeout(() => {
                testBasicConnectivity();
                testHelloAPI();
            }, 1000);
        };
    </script>
</body>
</html>
