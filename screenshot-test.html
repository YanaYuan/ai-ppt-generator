<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æˆªå›¾åŠŸèƒ½æµ‹è¯•</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #f5f5f5;
            padding: 20px;
            margin: 0;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            margin-bottom: 20px;
        }
        .test-btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
        }
        .test-btn:hover {
            background: #0056b3;
        }
        .test-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .result {
            margin-top: 20px;
            padding: 15px;
            border-radius: 6px;
            font-family: monospace;
        }
        .success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        .warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        canvas {
            border: 1px solid #ddd;
            margin-top: 10px;
            max-width: 100%;
        }
        .browser-info {
            background: #e9ecef;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
        }
        .feature-check {
            display: flex;
            align-items: center;
            margin: 5px 0;
        }
        .check-icon {
            margin-right: 10px;
            font-weight: bold;
        }
        .supported { color: green; }
        .not-supported { color: red; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ“¸ AI PPTç»„ä»¶ç”Ÿæˆå™¨ - æˆªå›¾åŠŸèƒ½æµ‹è¯•</h1>
        
        <div class="browser-info">
            <h3>ğŸ” æµè§ˆå™¨å…¼å®¹æ€§æ£€æŸ¥</h3>
            <div id="compatibility-check"></div>
        </div>

        <div class="test-section">
            <h3>ğŸš€ åŠŸèƒ½æµ‹è¯•</h3>
            <button class="test-btn" id="test-basic" onclick="testBasicCapture()">åŸºç¡€å±å¹•æ•è·æµ‹è¯•</button>
            <button class="test-btn" id="test-area" onclick="testAreaSelection()">åŒºåŸŸé€‰æ‹©æµ‹è¯•</button>
            <button class="test-btn" id="clear-results" onclick="clearResults()">æ¸…é™¤ç»“æœ</button>
        </div>

        <div id="results"></div>
    </div>

    <script>
        // æ£€æŸ¥æµè§ˆå™¨å…¼å®¹æ€§
        function checkCompatibility() {
            const checks = [
                {
                    name: 'Screen Capture API',
                    supported: !!(navigator.mediaDevices && navigator.mediaDevices.getDisplayMedia),
                    note: 'æˆªå›¾åŠŸèƒ½çš„æ ¸å¿ƒAPI'
                },
                {
                    name: 'Canvas API',
                    supported: !!document.createElement('canvas').getContext,
                    note: 'å›¾åƒå¤„ç†å’Œè£å‰ª'
                },
                {
                    name: 'Window.open',
                    supported: !!window.open,
                    note: 'å¼¹çª—åŒºåŸŸé€‰æ‹©ç•Œé¢'
                },
                {
                    name: 'Fetch API',
                    supported: !!window.fetch,
                    note: 'OCR APIè°ƒç”¨'
                },
                {
                    name: 'HTTPSç¯å¢ƒ',
                    supported: location.protocol === 'https:' || location.hostname === 'localhost' || location.hostname === '127.0.0.1',
                    note: 'Screen Capture APIéœ€è¦å®‰å…¨ç¯å¢ƒ'
                }
            ];

            const container = document.getElementById('compatibility-check');
            container.innerHTML = checks.map(check => `
                <div class="feature-check">
                    <span class="check-icon ${check.supported ? 'supported' : 'not-supported'}">
                        ${check.supported ? 'âœ…' : 'âŒ'}
                    </span>
                    <span>${check.name}: ${check.supported ? 'æ”¯æŒ' : 'ä¸æ”¯æŒ'}</span>
                    <small style="margin-left: 10px; color: #666;">(${check.note})</small>
                </div>
            `).join('');

            // å¦‚æœæ˜¯file://åè®®ï¼Œæ˜¾ç¤ºè­¦å‘Š
            if (location.protocol === 'file:') {
                addResult('âš ï¸ å½“å‰ä½¿ç”¨file://åè®®ï¼ŒScreen Capture APIå¯èƒ½æ— æ³•æ­£å¸¸å·¥ä½œã€‚å»ºè®®ä½¿ç”¨HTTPSæˆ–æœ¬åœ°æœåŠ¡å™¨æµ‹è¯•ã€‚', 'warning');
            }
        }

        // åŸºç¡€å±å¹•æ•è·æµ‹è¯•
        async function testBasicCapture() {
            const btn = document.getElementById('test-basic');
            btn.disabled = true;
            btn.textContent = 'æµ‹è¯•ä¸­...';

            try {
                addResult('ğŸš€ å¼€å§‹åŸºç¡€å±å¹•æ•è·æµ‹è¯•...', 'info');

                // æ£€æŸ¥APIæ”¯æŒ
                if (!navigator.mediaDevices || !navigator.mediaDevices.getDisplayMedia) {
                    throw new Error('æµè§ˆå™¨ä¸æ”¯æŒScreen Capture API');
                }

                addResult('âœ… Screen Capture APIæ”¯æŒæ£€æŸ¥é€šè¿‡', 'success');

                // è¯·æ±‚å±å¹•å…±äº«
                addResult('ğŸ“‹ è¯·åœ¨å¼¹å‡ºçš„æƒé™å¯¹è¯æ¡†ä¸­é€‰æ‹©è¦å…±äº«çš„å±å¹•...', 'info');
                
                const stream = await navigator.mediaDevices.getDisplayMedia({
                    video: {
                        mediaSource: 'screen',
                        width: { ideal: 1920 },
                        height: { ideal: 1080 }
                    },
                    audio: false
                });

                addResult('âœ… å±å¹•å…±äº«æƒé™è·å–æˆåŠŸ', 'success');

                // åˆ›å»ºvideoå…ƒç´ 
                const video = document.createElement('video');
                video.srcObject = stream;
                video.autoplay = true;
                video.muted = true;
                video.style.width = '300px';
                video.style.height = '200px';

                // ç­‰å¾…è§†é¢‘åŠ è½½
                await new Promise(resolve => {
                    video.addEventListener('loadedmetadata', resolve);
                });

                addResult('âœ… è§†é¢‘æµåˆ›å»ºæˆåŠŸ', 'success');

                // ç­‰å¾…ä¸€å¸§ç¡®ä¿æœ‰å†…å®¹
                await new Promise(resolve => {
                    const checkTime = () => {
                        if (video.currentTime > 0) {
                            resolve();
                        } else {
                            requestAnimationFrame(checkTime);
                        }
                    };
                    checkTime();
                });

                // åˆ›å»ºcanvasæˆªå›¾
                const canvas = document.createElement('canvas');
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                canvas.style.maxWidth = '400px';
                canvas.style.border = '1px solid #ddd';

                const ctx = canvas.getContext('2d');
                ctx.drawImage(video, 0, 0);

                addResult('âœ… å±å¹•æˆªå›¾æˆåŠŸ', 'success');

                // æ˜¾ç¤ºæˆªå›¾ç»“æœ
                const resultDiv = document.createElement('div');
                resultDiv.className = 'result success';
                resultDiv.innerHTML = `
                    <strong>ğŸ“¸ æˆªå›¾ç»“æœï¼š</strong><br>
                    åˆ†è¾¨ç‡: ${canvas.width} Ã— ${canvas.height}<br>
                    <br>
                `;
                resultDiv.appendChild(canvas);
                document.getElementById('results').appendChild(resultDiv);

                // åœæ­¢å±å¹•å…±äº«
                stream.getTracks().forEach(track => track.stop());
                addResult('âœ… èµ„æºæ¸…ç†å®Œæˆ', 'success');

            } catch (error) {
                console.error('åŸºç¡€æˆªå›¾æµ‹è¯•å¤±è´¥:', error);
                
                let errorMessage = 'åŸºç¡€æˆªå›¾æµ‹è¯•å¤±è´¥: ';
                if (error.name === 'NotAllowedError') {
                    errorMessage += 'ç”¨æˆ·æ‹’ç»äº†å±å¹•å…±äº«æƒé™';
                } else if (error.name === 'NotSupportedError') {
                    errorMessage += 'æµè§ˆå™¨ä¸æ”¯æŒScreen Capture API';
                } else {
                    errorMessage += error.message;
                }
                
                addResult('âŒ ' + errorMessage, 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = 'åŸºç¡€å±å¹•æ•è·æµ‹è¯•';
            }
        }

        // åŒºåŸŸé€‰æ‹©æµ‹è¯•
        async function testAreaSelection() {
            const btn = document.getElementById('test-area');
            btn.disabled = true;
            btn.textContent = 'æµ‹è¯•ä¸­...';

            try {
                addResult('ğŸš€ å¼€å§‹åŒºåŸŸé€‰æ‹©æµ‹è¯•...', 'info');

                // æ£€æŸ¥å¼¹çª—åŠŸèƒ½
                const testWindow = window.open('', '_blank', 'width=400,height=300');
                if (!testWindow) {
                    throw new Error('æ— æ³•æ‰“å¼€å¼¹çª—ï¼Œè¯·æ£€æŸ¥æµè§ˆå™¨å¼¹çª—è®¾ç½®');
                }

                addResult('âœ… å¼¹çª—åˆ›å»ºæˆåŠŸ', 'success');

                // è®¾ç½®æµ‹è¯•å¼¹çª—å†…å®¹
                testWindow.document.write(`
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <style>
                            body {
                                font-family: sans-serif;
                                padding: 20px;
                                background: #f0f8ff;
                                text-align: center;
                            }
                            .test-content {
                                background: white;
                                padding: 20px;
                                border-radius: 8px;
                                box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                            }
                        </style>
                    </head>
                    <body>
                        <div class="test-content">
                            <h2>ğŸ¯ åŒºåŸŸé€‰æ‹©æµ‹è¯•çª—å£</h2>
                            <p>è¿™æ˜¯ä¸€ä¸ªæµ‹è¯•çª—å£ï¼Œç”¨äºéªŒè¯è·¨çª—å£æˆªå›¾åŠŸèƒ½ã€‚</p>
                            <p>è¯·åœ¨ä¸»çª—å£ä¸­ä½¿ç”¨æˆªå›¾åŠŸèƒ½æˆªå–æ­¤çª—å£ã€‚</p>
                            <button onclick="window.close()">å…³é—­çª—å£</button>
                        </div>
                    </body>
                    </html>
                `);

                // 3ç§’åè‡ªåŠ¨å…³é—­æµ‹è¯•çª—å£
                setTimeout(() => {
                    if (!testWindow.closed) {
                        testWindow.close();
                    }
                }, 5000);

                addResult('âœ… åŒºåŸŸé€‰æ‹©æµ‹è¯•çª—å£å·²åˆ›å»ºï¼Œè¯·ä½¿ç”¨ä¸»åº”ç”¨çš„æˆªå›¾åŠŸèƒ½æˆªå–è¯¥çª—å£', 'success');
                addResult('â„¹ï¸ æµ‹è¯•çª—å£å°†åœ¨5ç§’åè‡ªåŠ¨å…³é—­', 'info');

            } catch (error) {
                console.error('åŒºåŸŸé€‰æ‹©æµ‹è¯•å¤±è´¥:', error);
                addResult('âŒ åŒºåŸŸé€‰æ‹©æµ‹è¯•å¤±è´¥: ' + error.message, 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = 'åŒºåŸŸé€‰æ‹©æµ‹è¯•';
            }
        }

        // æ·»åŠ ç»“æœåˆ°é¡µé¢
        function addResult(message, type = 'info') {
            const resultDiv = document.createElement('div');
            resultDiv.className = `result ${type}`;
            resultDiv.innerHTML = `<strong>${new Date().toLocaleTimeString()}</strong> - ${message}`;
            document.getElementById('results').appendChild(resultDiv);
            
            // æ»šåŠ¨åˆ°æœ€æ–°ç»“æœ
            resultDiv.scrollIntoView({ behavior: 'smooth' });
        }

        // æ¸…é™¤ç»“æœ
        function clearResults() {
            document.getElementById('results').innerHTML = '';
        }

        // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥å…¼å®¹æ€§
        window.addEventListener('load', checkCompatibility);
    </script>
</body>
</html>
