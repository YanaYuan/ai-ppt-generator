<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>AI PPTç»„ä»¶ç”Ÿæˆå™¨</title>
    <link href="https://picture-search.tiangong.cn/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet"/>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet"/>
    <!-- å¤‡ç”¨CDN -->
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" onerror="console.log('Tailwind CSSå¤‡ç”¨CDNåŠ è½½å¤±è´¥')"/>
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.0.0/css/all.min.css" rel="stylesheet" onerror="console.log('Font Awesomeå¤‡ç”¨CDNåŠ è½½å¤±è´¥')"/>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <!-- æ·»åŠ Tesseract.jsç”¨äºæœ¬åœ°OCR -->
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5.0.0/dist/tesseract.min.js"></script>
    <!-- æœ¬åœ°é…ç½®æ–‡ä»¶ - ä»…åœ¨æœ¬åœ°å¼€å‘æ—¶ä½¿ç”¨ -->
    <script src="config.local.js" onerror="console.log('æœ¬åœ°é…ç½®æ–‡ä»¶æœªæ‰¾åˆ°ï¼Œå°†ä½¿ç”¨é»˜è®¤é…ç½®æˆ–ç¯å¢ƒå˜é‡')"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            color: white;
            min-height: 100vh;
        }

        .app-container {
            display: flex;
            height: 100vh;
        }

        .sidebar {
            width: 350px;
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(10px);
            border-right: 1px solid rgba(148, 163, 184, 0.2);
            overflow-y: auto;
            padding: 20px;
        }

        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 20px;
        }

        .preview-area {
            flex: 1;
            background: rgba(30, 41, 59, 0.3);
            border: 1px solid rgba(148, 163, 184, 0.2);
            border-radius: 12px;
            padding: 20px;
            position: relative;
            overflow: hidden;
        }

        .input-section {
            margin-bottom: 25px;
        }

        .input-label {
            display: block;
            font-size: 14px;
            font-weight: 600;
            color: #e2e8f0;
            margin-bottom: 8px;
        }

        .text-input {
            width: 100%;
            height: 120px;
            padding: 12px;
            border-radius: 8px 8px 0 0;
            border: 1px solid rgba(148, 163, 184, 0.3);
            border-bottom: none;
            background: rgba(30, 41, 59, 0.5);
            color: white;
            font-size: 14px;
            resize: vertical;
            font-family: inherit;
        }

        .text-input:focus {
            outline: none;
            border-color: #3b82f6;
        }

        .text-input:focus + .input-helper {
            border-color: #3b82f6;
        }

        /* è¾“å…¥å®¹å™¨æ ·å¼ */
        .input-container {
            position: relative;
        }

        /* è¾“å…¥åŠ©æ‰‹åŠŸèƒ½æ ·å¼ - ä¸æ–‡æœ¬æ¡†å½¢æˆç»Ÿä¸€æ•´ä½“ */
        .input-helper {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 12px;
            background: rgba(30, 41, 59, 0.5);
            border: 1px solid rgba(148, 163, 184, 0.3);
            border-top: none;
            border-radius: 0 0 8px 8px;
            transition: border-color 0.3s ease;
        }

        .helper-button {
            padding: 6px 10px;
            background: rgba(59, 130, 246, 0.2);
            color: #94a3b8;
            border: 1px solid rgba(148, 163, 184, 0.2);
            border-radius: 4px;
            font-size: 12px;
            font-weight: 400;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 6px;
            flex-shrink: 0;
        }

        .helper-button:hover {
            background: rgba(59, 130, 246, 0.3);
            color: #cbd5e1;
            border-color: rgba(59, 130, 246, 0.4);
        }

        .helper-button:disabled {
            background: rgba(100, 116, 139, 0.2);
            color: #64748b;
            cursor: not-allowed;
            border-color: rgba(148, 163, 184, 0.1);
        }

        .helper-button i {
            font-size: 11px;
        }

        .helper-status {
            font-size: 11px;
            color: #94a3b8;
            flex: 1;
            text-align: left;
            display: none;
        }

        .helper-status.loading {
            color: #60a5fa;
            display: block;
        }

        .helper-status.success {
            color: #4ade80;
            display: block;
        }

        .helper-status.error {
            color: #f87171;
            display: block;
        }

        .helper-preview {
            border-radius: 3px;
            max-width: 60px;
            max-height: 40px;
            border: 1px solid rgba(148, 163, 184, 0.3);
            display: none;
            flex-shrink: 0;
        }

        .component-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 12px;
            margin-bottom: 25px;
        }

        .component-option {
            padding: 15px;
            border: 2px solid rgba(148, 163, 184, 0.2);
            border-radius: 8px;
            background: rgba(30, 41, 59, 0.3);
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .component-option:hover {
            border-color: #3b82f6;
            background: rgba(59, 130, 246, 0.1);
        }

        .component-option.selected {
            border-color: #3b82f6;
            background: rgba(59, 130, 246, 0.2);
        }

        .component-icon {
            width: 40px;
            height: 40px;
            border-radius: 6px;
            background: rgba(59, 130, 246, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            color: #3b82f6;
            font-size: 18px;
        }

        .component-info h3 {
            font-size: 14px;
            font-weight: 600;
            color: #e2e8f0;
            margin-bottom: 2px;
        }

        .component-info p {
            font-size: 12px;
            color: #94a3b8;
        }

        .style-controls {
            background: rgba(15, 23, 42, 0.5);
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
        }

        .control-group {
            margin-bottom: 15px;
        }

        .control-label {
            display: block;
            font-size: 12px;
            color: #cbd5e1;
            margin-bottom: 5px;
        }

        .control-input {
            width: 100%;
            padding: 8px;
            border-radius: 4px;
            border: 1px solid rgba(148, 163, 184, 0.3);
            background: rgba(30, 41, 59, 0.5);
            color: white;
            font-size: 12px;
        }

        .color-picker {
            width: 100%;
            height: 35px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        .btn {
            padding: 12px 20px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            width: 100%;
        }

        .btn-primary {
            background: #3b82f6;
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            background: #2563eb;
        }

        .btn-primary:disabled {
            background: #64748b;
            cursor: not-allowed;
        }

        .loading-spinner {
            width: 16px;
            height: 16px;
            border: 2px solid transparent;
            border-top: 2px solid currentColor;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .preview-iframe {
            width: 100%;
            height: 100%;
            border: none;
            border-radius: 8px;
            background: white;
        }

        .empty-preview {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #94a3b8;
            text-align: center;
        }

        .empty-preview i {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .section-title {
            font-size: 16px;
            font-weight: 700;
            color: #e2e8f0;
            margin-bottom: 15px;
            padding-bottom: 8px;
            border-bottom: 1px solid rgba(148, 163, 184, 0.2);
        }

        .style-option {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 6px;
        }

        .style-option:hover {
            background: rgba(148, 163, 184, 0.1);
        }

        .style-option.active {
            background: rgba(59, 130, 246, 0.2);
            color: #3b82f6;
        }

        .style-preview {
            width: 20px;
            height: 20px;
            border-radius: 4px;
            border: 1px solid rgba(148, 163, 184, 0.3);
        }

        /* è¾“å…¥å¤´éƒ¨æ ·å¼ */
        .input-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .demo-button-inline {
            padding: 6px 12px;
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid rgba(16, 185, 129, 0.3);
            border-radius: 6px;
            color: #10b981;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 6px;
            flex-shrink: 0;
        }

        .demo-button-inline:hover {
            background: rgba(16, 185, 129, 0.15);
            border-color: rgba(16, 185, 129, 0.5);
            transform: translateY(-1px);
        }

        .demo-button-inline:active {
            transform: translateY(0);
        }

        .demo-button-inline i {
            font-size: 11px;
            color: #fbbf24;
        }

        /* Demoæ¡ˆä¾‹æ ·å¼ - å·²ç§»åŠ¨åˆ°æ ‡é¢˜è¡Œ */

        .demo-item::before {
            content: 'âœ¦';
            position: absolute;
            left: -2px;
            top: 50%;
            transform: translateY(-50%);
            opacity: 0;
            transition: all 0.3s ease;
            color: #3b82f6;
        }

        .demo-item:hover::before {
            opacity: 1;
            left: 6px;
        }

        /* é¢„è§ˆç»„ä»¶æ ·å¼ */
        .generated-preview {
            background: white;
            border-radius: 12px;
            padding: 30px;
            color: #1f2937;
            min-height: 400px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }

        .preview-header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #e5e7eb;
        }

        .preview-title {
            font-size: 28px;
            font-weight: 700;
            color: #1f2937;
            margin: 0;
        }

        /* ç®€çº¦åˆ—è¡¨ç»„ä»¶æ ·å¼ */
        .steps-container {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .step-item {
            display: flex;
            align-items: flex-start;
            gap: 15px;
            padding: 20px;
            background: #f9fafb;
            border-radius: 8px;
            border-left: 4px solid #3b82f6;
        }

        .step-indicator {
            flex-shrink: 0;
            width: 32px;
            height: 32px;
            background: #3b82f6;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .step-number {
            color: white;
            font-weight: 600;
            font-size: 14px;
        }

        .step-content {
            flex: 1;
        }

        .step-title {
            font-size: 18px;
            font-weight: 600;
            color: #1f2937;
            margin: 0 0 8px 0;
        }

        .step-description {
            font-size: 14px;
            color: #6b7280;
            margin: 0;
            line-height: 1.5;
        }

        /* å›¾æ ‡åˆ—è¡¨ç»„ä»¶æ ·å¼ */
        .values-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .value-item {
            padding: 20px;
            background: #f9fafb;
            border-radius: 8px;
            border-left: 4px solid #10b981;
            display: flex;
            align-items: flex-start;
            gap: 15px;
        }

        .value-icon {
            width: 40px;
            height: 40px;
            background: #10b981;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 18px;
            flex-shrink: 0;
        }

        .value-content {
            flex: 1;
        }

        .value-title {
            font-size: 16px;
            font-weight: 600;
            color: #1f2937;
            margin: 0 0 8px 0;
        }

        .value-description {
            font-size: 14px;
            color: #6b7280;
            margin: 0;
            line-height: 1.5;
        }

        /* è¡¨æ ¼ç»„ä»¶æ ·å¼ */
        .table-container {
            overflow-x: auto;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
        }

        .preview-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }

        .preview-table th {
            background: #f3f4f6;
            padding: 12px 15px;
            text-align: left;
            font-weight: 600;
            color: #374151;
            border-bottom: 2px solid #e5e7eb;
        }

        .preview-table td {
            padding: 12px 15px;
            border-bottom: 1px solid #e5e7eb;
            color: #6b7280;
        }

        .preview-table tr:hover {
            background: #f9fafb;
        }

        /* å›¾è¡¨ç»„ä»¶æ ·å¼ */
        .chart-container {
            background: white;
            border-radius: 8px;
            padding: 20px;
        }

        #chart-area {
            width: 100%;
            height: 300px;
        }

        /* å¯¹æ¯”ç»„ä»¶æ ·å¼ */
        .comparison-container {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            gap: 30px;
            align-items: start;
        }

        .comparison-side {
            background: #f9fafb;
            border-radius: 8px;
            padding: 25px;
        }

        .left-side {
            border-left: 4px solid #10b981;
        }

        .right-side {
            border-left: 4px solid #ef4444;
        }

        .side-title {
            font-size: 18px;
            font-weight: 600;
            color: #1f2937;
            margin: 0 0 15px 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .side-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .side-item {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            margin-bottom: 12px;
            font-size: 14px;
            color: #6b7280;
            line-height: 1.5;
        }

        .side-item:last-child {
            margin-bottom: 0;
        }

        .side-item i {
            margin-top: 2px;
            flex-shrink: 0;
        }

        .left-side .side-item i {
            color: #10b981;
        }

        .right-side .side-item i {
            color: #ef4444;
        }

        .comparison-divider {
            width: 2px;
            background: linear-gradient(to bottom, #10b981, #ef4444);
            border-radius: 2px;
            min-height: 200px;
        }

        /* ...existing code... */
    </style>
</head>
<body>
    <div class="app-container">
        <!-- ä¾§è¾¹æ  -->
        <div class="sidebar">
            <h1 class="text-xl font-bold mb-6">AI PPTç»„ä»¶ç”Ÿæˆå™¨</h1>
            
            <div class="input-section">
                <div class="input-header">
                    <label class="input-label">è¾“å…¥å†…å®¹</label>
                    <button class="demo-button-inline" id="demoButton">
                        <i class="fas fa-lightbulb"></i>
                        <span>ç»™æˆ‘ä¸€ä¸ªç¤ºä¾‹</span>
                    </button>
                </div>
                <div class="input-container">
                    <textarea 
                        class="text-input" 
                        id="userInput" 
                        placeholder="è¾“å…¥æ‚¨æƒ³è¦åˆ¶ä½œPPTçš„å†…å®¹ï¼ŒAIå°†è‡ªåŠ¨æ•´ç†å’Œç”Ÿæˆè§†è§‰åŒ–è¡¨è¾¾"
                    ></textarea>
                    
                    <!-- å›¾ç‰‡è¯†åˆ«åŠŸèƒ½ - ä½œä¸ºè¾“å…¥æ¡†çš„é™„å±åŠŸèƒ½ -->
                    <div class="input-helper">
                        <button class="helper-button" id="ocrButton" onclick="app.handleImageOCR()" title="ä»å‰ªè´´æ¿å›¾ç‰‡è¯†åˆ«æ–‡å­—å¹¶æ·»åŠ åˆ°è¾“å…¥æ¡†">
                            <i class="fas fa-image"></i>
                            <span>ä»å‰ªè´´æ¿å›¾ç‰‡è¯†åˆ«æ–‡å­—</span>
                        </button>
                        <div class="helper-status" id="ocrStatus"></div>
                        <img class="helper-preview" id="imagePreview" alt="å›¾ç‰‡é¢„è§ˆ">
                    </div>
                </div>
            </div>

            <!-- ç»„ä»¶é€‰æ‹© -->
            <div class="input-section">
                <label class="input-label">é€‰æ‹©ç»„ä»¶</label>
                <div class="component-grid">
                    <div class="component-option" data-component="core-value">
                        <div class="component-icon">
                            <i class="fas fa-list-ul"></i>
                        </div>
                        <div class="component-info">
                            <h3>å›¾æ ‡åˆ—è¡¨</h3>
                            <p>å¸¦å›¾æ ‡çš„è¦ç‚¹åˆ—è¡¨ï¼Œé€‚åˆå±•ç¤ºç‰¹è‰²åŠŸèƒ½</p>
                        </div>
                    </div>
                    
                    <div class="component-option" data-component="ai-transform">
                        <div class="component-icon">
                            <i class="fas fa-clipboard-list"></i>
                        </div>
                        <div class="component-info">
                            <h3>ç®€çº¦åˆ—è¡¨</h3>
                            <p>ç®€æ´çš„æ­¥éª¤æˆ–è¦ç‚¹åˆ—è¡¨ï¼Œé€‚åˆæµç¨‹å±•ç¤º</p>
                        </div>
                    </div>
                    
                    <div class="component-option" data-component="table-component">
                        <div class="component-icon">
                            <i class="fas fa-table"></i>
                        </div>
                        <div class="component-info">
                            <h3>æ•°æ®è¡¨æ ¼</h3>
                            <p>ç»“æ„åŒ–è¡¨æ ¼ï¼Œé€‚åˆåŠŸèƒ½å¯¹æ¯”å’Œæ•°æ®å±•ç¤º</p>
                        </div>
                    </div>
                    
                    <div class="component-option" data-component="chart-component">
                        <div class="component-icon">
                            <i class="fas fa-chart-bar"></i>
                        </div>
                        <div class="component-info">
                            <h3>æŸ±çŠ¶å›¾è¡¨</h3>
                            <p>å¯è§†åŒ–æ•°æ®å›¾è¡¨ï¼Œé€‚åˆé‡åŒ–æŒ‡æ ‡å±•ç¤º</p>
                        </div>
                    </div>
                    
                    <div class="component-option" data-component="left-right-component">
                        <div class="component-icon">
                            <i class="fas fa-balance-scale"></i>
                        </div>
                        <div class="component-info">
                            <h3>ä¼˜åŠ£å¯¹æ¯”</h3>
                            <p>å·¦å³åˆ†æ å¯¹æ¯”å±•ç¤ºï¼Œé€‚åˆæ–¹æ¡ˆæ¯”è¾ƒ</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ç”ŸæˆæŒ‰é’® -->
            <button class="btn btn-primary" id="generateBtn">
                <i class="fas fa-magic"></i>
                <span>ç”Ÿæˆé¢„è§ˆ</span>
            </button>
        </div>

        <!-- ä¸»å†…å®¹åŒºåŸŸ -->
        <div class="main-content">
            <div class="preview-area" id="previewArea">
                <div class="empty-preview">
                    <i class="fas fa-file-powerpoint"></i>
                    <h3>AI PPTç»„ä»¶ç”Ÿæˆå™¨</h3>
                    <p>è¾“å…¥å†…å®¹ï¼Œé€‰æ‹©ç»„ä»¶ï¼Œå³å¯ç”Ÿæˆä¸“ä¸šçš„PPTé¡µé¢</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        class AIPPTGenerator {
            constructor() {
                this.selectedComponent = 'core-value'; // é»˜è®¤é€‰æ‹©å›¾æ ‡åˆ—è¡¨ç»„ä»¶
                this.generatedContent = null;
                this.currentDemoIndex = 0; // å½“å‰demoæ¡ˆä¾‹çš„å¾ªç¯ç´¢å¼•
                this.allDemos = []; // æ‰€æœ‰demoæ¡ˆä¾‹çš„æ•°ç»„
                this.apiStatus = null; // APIçŠ¶æ€ç¼“å­˜
                this.initDemoCases();
                this.initEventListeners();
                this.initDefaultSelection();
                this.checkAPIStatus(); // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥APIçŠ¶æ€
            }

            // æ£€æŸ¥APIçŠ¶æ€
            async checkAPIStatus() {
                if (this.isLocalEnvironment()) {
                    console.log('æœ¬åœ°ç¯å¢ƒï¼Œè·³è¿‡APIçŠ¶æ€æ£€æŸ¥');
                    this.apiStatus = { available: true, type: 'local' };
                    return;
                }

                try {
                    console.log('ğŸ” æ£€æŸ¥ç”Ÿäº§ç¯å¢ƒAPIçŠ¶æ€...');
                    
                    // é¦–å…ˆæµ‹è¯•ç®€å•çš„hello API
                    const helloResponse = await fetch('/api/hello', {
                        method: 'GET',
                        headers: { 'Accept': 'application/json' }
                    });

                    if (helloResponse.ok) {
                        console.log('âœ… åŸºç¡€APIå¯ç”¨');
                        
                        // æµ‹è¯•è¯Šæ–­APIè·å–ç¯å¢ƒä¿¡æ¯
                        try {
                            const diagnosticResponse = await fetch('/api/diagnostic', {
                                method: 'GET',
                                headers: { 'Accept': 'application/json' }
                            });
                            
                            if (diagnosticResponse.ok) {
                                const diagnosticData = await diagnosticResponse.json();
                                console.log('ğŸ“Š ç¯å¢ƒè¯Šæ–­ä¿¡æ¯:', diagnosticData);
                                
                                this.apiStatus = {
                                    available: true,
                                    type: 'production',
                                    hasApiKey: diagnosticData.environmentVariables?.hasAzureApiKey || false,
                                    hasEndpoint: diagnosticData.environmentVariables?.hasAzureEndpoint || false,
                                    diagnosticInfo: diagnosticData
                                };
                                
                                // æ˜¾ç¤ºAPIçŠ¶æ€ä¿¡æ¯
                                this.showAPIStatus();
                            }
                        } catch (diagError) {
                            console.warn('è¯Šæ–­APIä¸å¯ç”¨ï¼Œä½†åŸºç¡€APIæ­£å¸¸');
                            this.apiStatus = { available: true, type: 'production', limited: true };
                        }
                    } else {
                        throw new Error(`APIæ£€æŸ¥å¤±è´¥: ${helloResponse.status}`);
                    }
                } catch (error) {
                    console.error('âŒ APIçŠ¶æ€æ£€æŸ¥å¤±è´¥:', error);
                    this.apiStatus = { 
                        available: false, 
                        error: error.message,
                        fallbackReady: true 
                    };
                    this.showAPIStatus();
                }
            }

            // æ˜¾ç¤ºAPIçŠ¶æ€
            showAPIStatus() {
                if (!this.apiStatus || this.isLocalEnvironment()) return;

                const sidebar = document.querySelector('.sidebar');
                let statusDiv = document.getElementById('api-status');
                
                if (!statusDiv) {
                    statusDiv = document.createElement('div');
                    statusDiv.id = 'api-status';
                    statusDiv.style.cssText = `
                        margin-bottom: 20px;
                        padding: 12px;
                        border-radius: 8px;
                        font-size: 12px;
                        line-height: 1.4;
                    `;
                    sidebar.insertBefore(statusDiv, sidebar.firstChild.nextSibling);
                }

                if (this.apiStatus.available) {
                    if (this.apiStatus.hasApiKey && this.apiStatus.hasEndpoint) {
                        statusDiv.style.background = 'rgba(16, 185, 129, 0.1)';
                        statusDiv.style.border = '1px solid rgba(16, 185, 129, 0.3)';
                        statusDiv.style.color = '#10b981';
                        statusDiv.innerHTML = `
                            <strong>ğŸŸ¢ AIæœåŠ¡å°±ç»ª</strong><br>
                            Azure OpenAI API å·²é…ç½®å®Œæˆï¼Œå°†ç”ŸæˆçœŸå®å†…å®¹
                        `;
                    } else {
                        statusDiv.style.background = 'rgba(245, 158, 11, 0.1)';
                        statusDiv.style.border = '1px solid rgba(245, 158, 11, 0.3)';
                        statusDiv.style.color = '#f59e0b';
                        statusDiv.innerHTML = `
                            <strong>ğŸŸ¡ APIéƒ¨åˆ†å¯ç”¨</strong><br>
                            APIç«¯ç‚¹å¯è®¿é—®ï¼Œä½†ç¯å¢ƒå˜é‡å¯èƒ½æœªé…ç½®å®Œæ•´<br>
                            <small>ç¼ºå°‘: ${!this.apiStatus.hasApiKey ? 'APIå¯†é’¥ ' : ''}${!this.apiStatus.hasEndpoint ? 'APIç«¯ç‚¹' : ''}</small>
                        `;
                    }
                } else {
                    statusDiv.style.background = 'rgba(239, 68, 68, 0.1)';
                    statusDiv.style.border = '1px solid rgba(239, 68, 68, 0.3)';
                    statusDiv.style.color = '#ef4444';
                    statusDiv.innerHTML = `
                        <strong>ğŸ”´ APIä¸å¯ç”¨</strong><br>
                        å°†ä½¿ç”¨æ¼”ç¤ºæ•°æ®ç¡®ä¿åŠŸèƒ½æ­£å¸¸<br>
                        <small>é”™è¯¯: ${this.apiStatus.error}</small>
                    `;
                }
            }

            initDefaultSelection() {
                // é»˜è®¤é€‰æ‹©å›¾æ ‡åˆ—è¡¨ç»„ä»¶
                setTimeout(() => {
                    const defaultComponent = document.querySelector('[data-component="core-value"]');
                    if (defaultComponent) {
                        defaultComponent.classList.add('selected');
                    }
                }, 100);
            }

            initDemoCases() {
                // Demoæ¡ˆä¾‹æ•°æ®
                this.demoCases = {
                    'core-value': [
                        'å±•ç¤ºæˆ‘ä»¬å…¬å¸çš„æ ¸å¿ƒä»·å€¼è§‚ï¼šåˆ›æ–°é©±åŠ¨ã€å®¢æˆ·è‡³ä¸Šã€å›¢é˜Ÿåä½œ'
                    ],
                    'ai-transform': [
                        'è½¯ä»¶å¼€å‘æ ‡å‡†æµç¨‹ï¼šéœ€æ±‚åˆ†æâ†’æ¶æ„è®¾è®¡â†’ç¼–ç å®ç°â†’æµ‹è¯•ä¸Šçº¿'
                    ],
                    'table-component': [
                        'å¯¹æ¯”ä¸‰ç§äº‘æœåŠ¡æ–¹æ¡ˆï¼šé˜¿é‡Œäº‘ï¼ˆæ ‡å‡†ç‰ˆï¼Œ2980å…ƒ/å¹´ï¼Œ4æ ¸8Gï¼Œ99.9%å¯ç”¨æ€§ï¼‰ï¼Œè…¾è®¯äº‘ï¼ˆä¸“ä¸šç‰ˆï¼Œ3200å…ƒ/å¹´ï¼Œ8æ ¸16Gï¼Œ99.8%å¯ç”¨æ€§ï¼‰ï¼Œåä¸ºäº‘ï¼ˆä¼ä¸šç‰ˆï¼Œ3800å…ƒ/å¹´ï¼Œ16æ ¸32Gï¼Œ99.95%å¯ç”¨æ€§ï¼‰'
                    ],
                    'chart-component': [
                        'å±•ç¤º2024å¹´å„å­£åº¦é”€å”®é¢ï¼šQ1å­£åº¦285ä¸‡ï¼ŒQ2å­£åº¦320ä¸‡ï¼ŒQ3å­£åº¦378ä¸‡ï¼ŒQ4å­£åº¦425ä¸‡'
                    ],
                    'left-right-component': [
                        'å¯¹æ¯”ä¼ ç»ŸåŠå…¬ä¸è¿œç¨‹åŠå…¬ï¼šä¼ ç»ŸåŠå…¬ä¼˜åŠ¿ï¼ˆé¢å¯¹é¢æ²Ÿé€šã€å›¢é˜Ÿæ°›å›´å¥½ã€åä½œæ•ˆç‡é«˜ï¼‰ï¼ŒåŠ£åŠ¿ï¼ˆé€šå‹¤æ—¶é—´é•¿ã€æˆæœ¬é«˜ã€åœ°ç‚¹é™åˆ¶ï¼‰ï¼›è¿œç¨‹åŠå…¬ä¼˜åŠ¿ï¼ˆæ—¶é—´çµæ´»ã€æˆæœ¬ä½ã€è¦†ç›–é¢å¹¿ï¼‰ï¼ŒåŠ£åŠ¿ï¼ˆæ²Ÿé€šæˆæœ¬é«˜ã€ç›‘ç®¡å›°éš¾ã€å›¢é˜Ÿå‡èšåŠ›å¼±ï¼‰'
                    ]
                };

                // åˆå§‹åŒ–æ‰€æœ‰demoæ¡ˆä¾‹æ•°ç»„ï¼Œç”¨äºå¾ªç¯é€‰æ‹©
                this.allDemos = [];
                const componentTypes = Object.keys(this.demoCases);
                componentTypes.forEach(componentType => {
                    this.demoCases[componentType].forEach(demoText => {
                        this.allDemos.push({
                            componentType: componentType,
                            text: demoText
                        });
                    });
                });
            }

            // æŒ‰é¡ºåºå¾ªç¯å¡«å……demoæ¡ˆä¾‹
            fillRandomDemo() {
                // æ£€æŸ¥æ˜¯å¦æœ‰demoæ¡ˆä¾‹
                if (this.allDemos.length === 0) {
                    console.error('æ²¡æœ‰å¯ç”¨çš„demoæ¡ˆä¾‹');
                    return;
                }
                
                // è·å–å½“å‰ç´¢å¼•å¯¹åº”çš„demoæ¡ˆä¾‹
                const selectedDemo = this.allDemos[this.currentDemoIndex];
                
                // æ›´æ–°ç´¢å¼•ï¼Œå¾ªç¯åˆ°ä¸‹ä¸€ä¸ª
                this.currentDemoIndex = (this.currentDemoIndex + 1) % this.allDemos.length;
                
                // å¡«å……è¾“å…¥æ¡†
                const inputField = document.getElementById('userInput');
                inputField.value = selectedDemo.text;
                
                // é€‰ä¸­å¯¹åº”çš„ç»„ä»¶
                document.querySelectorAll('.component-option').forEach(option => {
                    option.classList.remove('selected');
                    if (option.dataset.component === selectedDemo.componentType) {
                        option.classList.add('selected');
                    }
                });
                
                // æ›´æ–°é€‰ä¸­çš„ç»„ä»¶ç±»å‹
                this.selectedComponent = selectedDemo.componentType;
                
                // èšç„¦åˆ°è¾“å…¥æ¡†å¹¶å°†å…‰æ ‡ç§»åˆ°æœ«å°¾
                inputField.focus();
                inputField.setSelectionRange(inputField.value.length, inputField.value.length);
                
                // ç»™æŒ‰é’®æ·»åŠ ç®€å•çš„åé¦ˆæ•ˆæœ
                const demoButton = document.querySelector('.demo-button-inline');
                demoButton.style.background = 'rgba(16, 185, 129, 0.2)';
                setTimeout(() => {
                    demoButton.style.background = 'rgba(16, 185, 129, 0.1)';
                }, 300);
            }

            initEventListeners() {
                console.log('æ­£åœ¨åˆå§‹åŒ–äº‹ä»¶ç›‘å¬å™¨...');
                
                // ç»„ä»¶é€‰æ‹©
                document.querySelectorAll('.component-option').forEach(option => {
                    option.addEventListener('click', (e) => {
                        console.log('ç»„ä»¶é€‰æ‹©:', option.dataset.component);
                        document.querySelectorAll('.component-option').forEach(o => o.classList.remove('selected'));
                        option.classList.add('selected');
                        this.selectedComponent = option.dataset.component;
                    });
                });

                // ç”ŸæˆæŒ‰é’®
                const generateBtn = document.getElementById('generateBtn');
                if (generateBtn) {
                    generateBtn.addEventListener('click', () => {
                        console.log('ç”ŸæˆæŒ‰é’®è¢«ç‚¹å‡»äº†ï¼');
                        this.generatePreview();
                    });
                    console.log('ç”ŸæˆæŒ‰é’®äº‹ä»¶ç›‘å¬å™¨å·²ç»‘å®š');
                } else {
                    console.error('æ‰¾ä¸åˆ°ç”ŸæˆæŒ‰é’®ï¼');
                }

                // ç¤ºä¾‹æŒ‰é’®
                const demoButton = document.getElementById('demoButton');
                if (demoButton) {
                    demoButton.addEventListener('click', () => {
                        this.fillRandomDemo();
                    });
                    console.log('ç¤ºä¾‹æŒ‰é’®äº‹ä»¶ç›‘å¬å™¨å·²ç»‘å®š');
                } else {
                    console.error('æ‰¾ä¸åˆ°ç¤ºä¾‹æŒ‰é’®ï¼');
                }
            }

            async generatePreview() {
                console.log('generatePreviewæ–¹æ³•è¢«è°ƒç”¨');
                const userInput = document.getElementById('userInput').value.trim();
                console.log('ç”¨æˆ·è¾“å…¥:', userInput);
                console.log('é€‰æ‹©çš„ç»„ä»¶:', this.selectedComponent);
                
                if (!userInput) {
                    alert('è¯·è¾“å…¥å†…å®¹');
                    return;
                }

                if (!this.selectedComponent) {
                    alert('è¯·é€‰æ‹©ç»„ä»¶');
                    return;
                }

                const generateBtn = document.getElementById('generateBtn');
                const btnText = generateBtn.querySelector('span');
                const btnIcon = generateBtn.querySelector('i');
                
                // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                generateBtn.disabled = true;
                btnIcon.className = 'loading-spinner';
                btnText.textContent = 'ç”Ÿæˆä¸­...';

                try {
                    // è°ƒç”¨Azure OpenAI API
                    const structuredContent = await this.callAzureOpenAI(userInput, this.selectedComponent);
                    
                    console.log('ç”Ÿæˆçš„å†…å®¹:', structuredContent);
                    
                    // ç”Ÿæˆé¢„è§ˆ
                    this.generatedContent = structuredContent;
                    this.renderPreview();
                    
                    // æ£€æŸ¥æ˜¯å¦ä½¿ç”¨äº†æ¨¡æ‹Ÿæ•°æ®ï¼Œå¹¶æ·»åŠ é€‚å½“çš„æç¤º
                    this.addDataSourceNotice(structuredContent);
                    
                } catch (error) {
                    console.error('ç”Ÿæˆå¤±è´¥:', error);
                    
                    // æ”¹è¿›çš„é”™è¯¯å¤„ç†ï¼šæ€»æ˜¯èƒ½æä¾›å†…å®¹ç»™ç”¨æˆ·
                    console.warn('APIè°ƒç”¨å¤±è´¥ï¼Œä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®ç¡®ä¿ç”¨æˆ·ä½“éªŒ');
                    try {
                        const mockContent = this.generateMockData(userInput, this.selectedComponent);
                        this.generatedContent = mockContent;
                        this.renderPreview();
                        
                        // åœ¨é¢„è§ˆä¸­æ˜¾ç¤ºAPIé”™è¯¯æç¤ºï¼Œä½†ä¸å½±å“å†…å®¹å±•ç¤º
                        this.addErrorNoticeWithContent(error);
                        
                    } catch (mockError) {
                        console.error('è¿æ¨¡æ‹Ÿæ•°æ®éƒ½ç”Ÿæˆå¤±è´¥:', mockError);
                        alert('ç”Ÿæˆå¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
                    }
                } finally {
                    // æ¢å¤æŒ‰é’®çŠ¶æ€
                    generateBtn.disabled = false;
                    btnIcon.className = 'fas fa-magic';
                    btnText.textContent = 'ç”Ÿæˆé¢„è§ˆ';
                }
            }

            // æ·»åŠ æ•°æ®æ¥æºæç¤º
            addDataSourceNotice(content) {
                const previewArea = document.getElementById('previewArea');
                
                // ç§»é™¤ä¹‹å‰çš„æç¤º
                const existingNotice = previewArea.querySelector('.data-source-notice');
                if (existingNotice) {
                    existingNotice.remove();
                }
                
                // æ£€æŸ¥æ˜¯å¦æ˜¯æ¨¡æ‹Ÿæ•°æ®ï¼ˆé€šè¿‡ç‰¹å®šæ ‡è¯†åˆ¤æ–­ï¼‰
                const isMockData = this.isMockData(content);
                
                if (isMockData) {
                    const noticeDiv = document.createElement('div');
                    noticeDiv.className = 'data-source-notice';
                    noticeDiv.innerHTML = `
                        <div style="background: #dbeafe; border: 1px solid #3b82f6; border-radius: 8px; padding: 12px; margin-bottom: 20px; color: #1e40af;">
                            <strong>â„¹ï¸ æç¤ºï¼š</strong> å½“å‰ä½¿ç”¨æ¼”ç¤ºæ•°æ®ï¼Œå®é™…ä½¿ç”¨æ—¶ä¼šè°ƒç”¨AIç”ŸæˆçœŸå®å†…å®¹ã€‚
                        </div>
                    `;
                    previewArea.insertBefore(noticeDiv, previewArea.firstChild);
                }
            }

            // æ·»åŠ é”™è¯¯æç¤ºä½†ä¿ç•™å†…å®¹
            addErrorNoticeWithContent(error) {
                const previewArea = document.getElementById('previewArea');
                
                // ç§»é™¤ä¹‹å‰çš„æç¤º
                const existingNotice = previewArea.querySelector('.data-source-notice');
                if (existingNotice) {
                    existingNotice.remove();
                }
                
                const noticeDiv = document.createElement('div');
                noticeDiv.className = 'data-source-notice';
                noticeDiv.innerHTML = `
                    <div style="background: #fef3c7; border: 1px solid #f59e0b; border-radius: 8px; padding: 12px; margin-bottom: 20px; color: #92400e;">
                        <strong>âš ï¸ æ³¨æ„ï¼š</strong> AIæœåŠ¡æš‚æ—¶ä¸å¯ç”¨ï¼Œå·²ä½¿ç”¨æ¼”ç¤ºæ•°æ®ç¡®ä¿åŠŸèƒ½æ­£å¸¸ã€‚æŠ€æœ¯é—®é¢˜ï¼š${error.message.substring(0, 100)}...
                        <details style="margin-top: 8px; font-size: 12px;">
                            <summary style="cursor: pointer;">æŸ¥çœ‹æŠ€æœ¯è¯¦æƒ…</summary>
                            <pre style="margin-top: 5px; font-size: 11px; white-space: pre-wrap;">${error.message}</pre>
                        </details>
                    </div>
                `;
                previewArea.insertBefore(noticeDiv, previewArea.firstChild);
            }

            // åˆ¤æ–­æ˜¯å¦ä¸ºæ¨¡æ‹Ÿæ•°æ®
            isMockData(content) {
                if (!content || typeof content !== 'object') return false;
                
                // é€šè¿‡æ£€æŸ¥ä¸€äº›æ¨¡æ‹Ÿæ•°æ®çš„ç‰¹å¾æ¥åˆ¤æ–­
                const mockIndicators = [
                    'æ¼”ç¤ºæ•°æ®', 'ç¤ºä¾‹å†…å®¹', 'è¯·è¾“å…¥', 'Mock', 'Demo',
                    'æ ¸å¿ƒä»·å€¼è§‚', 'å…³é”®æµç¨‹æ­¥éª¤', 'åŠŸèƒ½å¯¹æ¯”åˆ†æ', 'é”€å”®ä¸šç»©ç»Ÿè®¡'
                ];
                
                const contentStr = JSON.stringify(content).toLowerCase();
                return mockIndicators.some(indicator => 
                    contentStr.includes(indicator.toLowerCase())
                );
            }

            async callAzureOpenAI(userInput, componentType) {
                // ç¯å¢ƒæ£€æµ‹ï¼šåˆ¤æ–­æ˜¯å¦åœ¨æœ¬åœ°å¼€å‘ç¯å¢ƒ
                const isLocalEnvironment = this.isLocalEnvironment();
                
                if (isLocalEnvironment) {
                    // æœ¬åœ°ç¯å¢ƒï¼šç›´æ¥ä½¿ç”¨Azure OpenAI
                    return await this.callAzureOpenAIDirect(userInput, componentType);
                } else {
                    // ç”Ÿäº§ç¯å¢ƒï¼šä½¿ç”¨Vercelä»£ç†
                    return await this.callAzureOpenAIViaProxy(userInput, componentType);
                }
            }

            // æ£€æµ‹æ˜¯å¦ä¸ºæœ¬åœ°ç¯å¢ƒ
            isLocalEnvironment() {
                const hostname = window.location.hostname;
                return hostname === 'localhost' || 
                       hostname === '127.0.0.1' || 
                       hostname.startsWith('192.168.') || 
                       hostname.startsWith('10.') || 
                       hostname.startsWith('172.') ||
                       hostname === '' ||
                       window.location.protocol === 'file:';
            }

            // ç›´æ¥è°ƒç”¨Azure OpenAIï¼ˆæœ¬åœ°ç¯å¢ƒï¼‰
            async callAzureOpenAIDirect(userInput, componentType) {
                // ä¼˜å…ˆä½¿ç”¨æœ¬åœ°é…ç½®æ–‡ä»¶ä¸­çš„è®¾ç½®
                let apiKey, baseEndpoint, deployment, apiVersion;
                
                if (window.LOCAL_CONFIG) {
                    apiKey = window.LOCAL_CONFIG.AZURE_OPENAI_API_KEY;
                    baseEndpoint = window.LOCAL_CONFIG.AZURE_OPENAI_ENDPOINT;
                    deployment = window.LOCAL_CONFIG.AZURE_OPENAI_DEPLOYMENT || 'gpt-4o';
                    apiVersion = window.LOCAL_CONFIG.AZURE_OPENAI_API_VERSION || '2024-02-01';
                } else {
                    // æœ¬åœ°å¼€å‘æ—¶çš„ç¡¬ç¼–ç é…ç½®ï¼ˆä»…æœ¬åœ°å¯è§ï¼‰
                    apiKey = 'af60f8ec72694fc8bbb785f492ae9a02';
                    baseEndpoint = 'https://xxx-your-azure-endpoint.openai.azure.com'; // æ”¹æˆä½ çš„å®é™…endpoint
                    deployment = 'gpt-4o';
                    apiVersion = '2024-02-01';
                }
                
                // å¦‚æœendpointè¿˜æ˜¯ç¤ºä¾‹åœ°å€ï¼Œä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®
                if (!baseEndpoint || baseEndpoint.includes('xxx-your-azure-endpoint')) {
                    console.warn('è¯·åœ¨ä»£ç ä¸­é…ç½®çœŸå®çš„Azure OpenAI endpointï¼Œå½“å‰ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®');
                    return this.generateMockData(userInput, componentType);
                }
                
                const endpoint = `${baseEndpoint.replace(/\/$/, '')}/openai/deployments/${deployment}/chat/completions?api-version=${apiVersion}`;
                
                // æ„å»ºprompt
                const prompt = this.buildPrompt(userInput, componentType);
                
                // æ£€æŸ¥æ˜¯å¦ä½¿ç”¨äº†è°ƒè¯•å™¨çš„prompt
                const debuggedPromptData = localStorage.getItem('debuggedPrompt');
                if (debuggedPromptData) {
                    try {
                        const promptConfig = JSON.parse(debuggedPromptData);
                        const oneHour = 60 * 60 * 1000;
                        if (promptConfig.componentType === componentType && 
                            (Date.now() - promptConfig.timestamp) < oneHour) {
                            console.log('æ­£åœ¨ä½¿ç”¨è°ƒè¯•å™¨ä¸­ä¼˜åŒ–çš„prompt');
                            // å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ UIæç¤º
                            this.showDebuggerPromptNotice();
                        }
                    } catch (e) {
                        // å¿½ç•¥è§£æé”™è¯¯
                    }
                }
                
                console.log('å‘é€ç»™AIçš„prompt:', prompt);

                const requestBody = {
                    messages: [
                        {
                            role: "system",
                            content: "ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„PPTå†…å®¹ç”ŸæˆåŠ©æ‰‹ï¼Œæ“…é•¿æ ¹æ®ç”¨æˆ·è¾“å…¥ç”Ÿæˆç»“æ„åŒ–çš„æ¼”ç¤ºæ–‡ç¨¿å†…å®¹ã€‚è¯·å§‹ç»ˆè¿”å›æœ‰æ•ˆçš„JSONæ ¼å¼æ•°æ®ï¼Œç¡®ä¿å†…å®¹ä¸“ä¸šã€å‡†ç¡®ã€æœ‰æ¡ç†ã€‚ä¸è¦åŒ…å«ä»»ä½•markdownæ ¼å¼æˆ–å…¶ä»–è£…é¥°æ–‡å­—ï¼Œåªè¿”å›çº¯JSONã€‚"
                        },
                        {
                            role: "user",
                            content: prompt
                        }
                    ],
                    max_tokens: 1500,
                    temperature: 0.7
                };

                try {
                    const response = await fetch(endpoint, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'api-key': apiKey
                        },
                        body: JSON.stringify(requestBody)
                    });

                    if (!response.ok) {
                        console.error('APIå“åº”é”™è¯¯:', response.status, response.statusText);
                        // å¦‚æœAPIè°ƒç”¨å¤±è´¥ï¼Œå›é€€åˆ°æ¨¡æ‹Ÿæ•°æ®
                        return this.generateMockData(userInput, componentType);
                    }

                    const data = await response.json();
                    const aiResponse = data.choices[0].message.content;
                    
                    console.log('AIåŸå§‹å“åº”:', aiResponse);
                    
                    // è§£æAIå“åº”ä¸ºJSON
                    try {
                        // æ¸…ç†å“åº”å†…å®¹ï¼Œç§»é™¤å¯èƒ½çš„markdownæ ‡è®°
                        let cleanResponse = aiResponse.trim();
                        if (cleanResponse.startsWith('```json')) {
                            cleanResponse = cleanResponse.replace(/^```json\s*/i, '').replace(/\s*```$/, '');
                        } else if (cleanResponse.startsWith('```')) {
                            cleanResponse = cleanResponse.replace(/^```\s*/, '').replace(/\s*```$/, '');
                        }
                        
                        const jsonData = JSON.parse(cleanResponse);
                        console.log('è§£ææˆåŠŸçš„JSONæ•°æ®:', jsonData);
                        return jsonData;
                    } catch (parseError) {
                        console.error('è§£æAIå“åº”å¤±è´¥:', parseError);
                        console.log('åŸå§‹å“åº”å†…å®¹:', aiResponse);
                        // å¦‚æœè§£æå¤±è´¥ï¼Œå›é€€åˆ°æ¨¡æ‹Ÿæ•°æ®
                        return this.generateMockData(userInput, componentType);
                    }
                } catch (error) {
                    console.error('APIè°ƒç”¨é”™è¯¯:', error);
                    // å¦‚æœç½‘ç»œé”™è¯¯ï¼Œå›é€€åˆ°æ¨¡æ‹Ÿæ•°æ®
                    return this.generateMockData(userInput, componentType);
                }
            }

            // é€šè¿‡Vercelä»£ç†è°ƒç”¨Azure OpenAIï¼ˆç”Ÿäº§ç¯å¢ƒï¼‰
            async callAzureOpenAIViaProxy(userInput, componentType) {
                // æ„å»ºprompt
                const prompt = this.buildPrompt(userInput, componentType);
                
                console.log('ç”Ÿäº§ç¯å¢ƒ - å‘é€ç»™AIçš„prompt:', prompt);
                console.log('å½“å‰URL:', window.location.href);
                console.log('ç»„ä»¶ç±»å‹:', componentType);
                console.log('ç”¨æˆ·è¾“å…¥:', userInput);

                const requestBody = {
                    userInput: userInput,
                    componentType: componentType,
                    prompt: prompt
                };

                console.log('å‡†å¤‡å‘é€çš„è¯·æ±‚ä½“:', requestBody);

                // ä½¿ç”¨å¤šé‡é‡è¯•ç­–ç•¥
                const maxRetries = 3;
                let lastError = null;

                for (let attempt = 1; attempt <= maxRetries; attempt++) {
                    try {
                        console.log(`ğŸ”„ å°è¯•ç¬¬ ${attempt} æ¬¡è°ƒç”¨ä»£ç†API /api/openai...`);
                        
                        const response = await fetch('/api/openai', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(requestBody)
                        });

                        console.log('ä»£ç†APIå“åº”çŠ¶æ€:', response.status, response.statusText);
                        console.log('å“åº”å¤´ä¿¡æ¯:', Object.fromEntries(response.headers.entries()));

                        if (!response.ok) {
                            const errorText = await response.text();
                            console.error(`ç¬¬ ${attempt} æ¬¡å°è¯•å¤±è´¥:`, response.status, response.statusText, errorText);
                            
                            // å¦‚æœæ˜¯404é”™è¯¯ï¼Œç«‹å³è¿”å›æ¨¡æ‹Ÿæ•°æ®ï¼Œä¸å†é‡è¯•
                            if (response.status === 404) {
                                console.warn('âš ï¸ APIç«¯ç‚¹æœªæ‰¾åˆ°(404)ï¼Œä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®ä½œä¸ºåå¤‡æ–¹æ¡ˆ');
                                return this.generateMockData(userInput, componentType);
                            }
                            
                            // å¦‚æœæ˜¯500é”™è¯¯ä¸”ä¸æ˜¯æœ€åä¸€æ¬¡å°è¯•ï¼Œç­‰å¾…åé‡è¯•
                            if (response.status >= 500 && attempt < maxRetries) {
                                console.log(`æœåŠ¡å™¨é”™è¯¯ï¼Œç­‰å¾… ${attempt * 1000}ms åé‡è¯•...`);
                                await new Promise(resolve => setTimeout(resolve, attempt * 1000));
                                lastError = new Error(`æœåŠ¡å™¨é”™è¯¯: ${response.status} ${response.statusText}`);
                                continue;
                            }
                            
                            // å…¶ä»–é”™è¯¯ï¼Œå°è¯•è§£æé”™è¯¯ä¿¡æ¯
                            try {
                                const errorData = JSON.parse(errorText);
                                console.error('è§£æçš„é”™è¯¯æ•°æ®:', errorData);
                                lastError = new Error(`APIé”™è¯¯: ${errorData.error || errorText}`);
                            } catch (e) {
                                lastError = new Error(`APIè°ƒç”¨å¤±è´¥: ${response.status} ${response.statusText} - ${errorText}`);
                            }
                            
                            // å¦‚æœæ˜¯æœ€åä¸€æ¬¡å°è¯•ï¼Œä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®
                            if (attempt === maxRetries) {
                                console.warn('âš ï¸ æ‰€æœ‰é‡è¯•éƒ½å¤±è´¥ï¼Œä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®ä½œä¸ºåå¤‡æ–¹æ¡ˆ');
                                return this.generateMockData(userInput, componentType);
                            }
                            continue;
                        }

                        // æˆåŠŸå“åº”ï¼Œè§£ææ•°æ®
                        const jsonData = await response.json();
                        console.log('ä»£ç†APIè¿”å›çš„åŸå§‹æ•°æ®:', jsonData);
                        console.log('æ•°æ®ç±»å‹:', typeof jsonData);
                        console.log('æ•°æ®é”®:', Object.keys(jsonData));
                        
                        // éªŒè¯è¿”å›çš„æ•°æ®ç»“æ„
                        if (this.validateComponentData(jsonData, componentType)) {
                            console.log('âœ… æ•°æ®éªŒè¯é€šè¿‡ï¼Œè¿”å›çœŸå®æ•°æ®');
                            return jsonData;
                        } else {
                            console.error('âŒ APIè¿”å›çš„æ•°æ®ç»“æ„ä¸æ­£ç¡®');
                            console.error('æœŸæœ›çš„ç»„ä»¶ç±»å‹:', componentType);
                            console.error('å®é™…è¿”å›çš„æ•°æ®:', jsonData);
                            
                            // æ•°æ®ç»“æ„é”™è¯¯ï¼Œä¹Ÿä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®
                            console.warn('âš ï¸ æ•°æ®ç»“æ„éªŒè¯å¤±è´¥ï¼Œä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®ä½œä¸ºåå¤‡æ–¹æ¡ˆ');
                            return this.generateMockData(userInput, componentType);
                        }

                    } catch (error) {
                        console.error(`âŒ ç¬¬ ${attempt} æ¬¡ä»£ç†APIè°ƒç”¨è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯:`, error);
                        lastError = error;
                        
                        // å¦‚æœæ˜¯ç½‘ç»œé”™è¯¯ä¸”ä¸æ˜¯æœ€åä¸€æ¬¡å°è¯•ï¼Œç­‰å¾…åé‡è¯•
                        if (attempt < maxRetries) {
                            console.log(`ç½‘ç»œé”™è¯¯ï¼Œç­‰å¾… ${attempt * 1000}ms åé‡è¯•...`);
                            await new Promise(resolve => setTimeout(resolve, attempt * 1000));
                            continue;
                        }
                        
                        // æœ€åä¸€æ¬¡å°è¯•ä¹Ÿå¤±è´¥ï¼Œä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®
                        console.warn('âš ï¸ æ‰€æœ‰é‡è¯•éƒ½å¤±è´¥ï¼Œä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®ä½œä¸ºåå¤‡æ–¹æ¡ˆ');
                        return this.generateMockData(userInput, componentType);
                    }
                }

                // å¦‚æœæ‰€æœ‰é‡è¯•éƒ½å¤±è´¥ï¼Œä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®
                console.warn('âš ï¸ æ‰€æœ‰APIè°ƒç”¨å°è¯•éƒ½å¤±è´¥ï¼Œä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®');
                console.error('æœ€åçš„é”™è¯¯:', lastError);
                return this.generateMockData(userInput, componentType);
            }

            // éªŒè¯ç»„ä»¶æ•°æ®ç»“æ„çš„å®Œæ•´æ€§
            validateComponentData(data, componentType) {
                console.log('éªŒè¯ç»„ä»¶æ•°æ®:', componentType, data);
                
                if (!data || typeof data !== 'object') {
                    console.error('æ•°æ®ä¸æ˜¯æœ‰æ•ˆçš„å¯¹è±¡:', data);
                    return false;
                }

                switch (componentType) {
                    case 'ai-transform':
                        if (!data.title || !Array.isArray(data.steps)) {
                            console.error('ç®€çº¦åˆ—è¡¨ç»„ä»¶æ•°æ®ç»“æ„é”™è¯¯:', data);
                            return false;
                        }
                        for (const step of data.steps) {
                            if (!step.title || !step.description) {
                                console.error('æ­¥éª¤æ•°æ®ç»“æ„é”™è¯¯:', step);
                                return false;
                            }
                        }
                        console.log('ç®€çº¦åˆ—è¡¨ç»„ä»¶æ•°æ®éªŒè¯é€šè¿‡');
                        return true;
                    case 'core-value':
                        const valid = data.title && Array.isArray(data.values);
                        console.log('å›¾æ ‡åˆ—è¡¨ç»„ä»¶æ•°æ®éªŒè¯:', valid);
                        return valid;
                    case 'table-component':
                        const tableValid = data.title && Array.isArray(data.headers) && Array.isArray(data.rows);
                        console.log('è¡¨æ ¼ç»„ä»¶æ•°æ®éªŒè¯:', tableValid);
                        return tableValid;
                    case 'chart-component':
                        const chartValid = data.title && Array.isArray(data.chartData);
                        console.log('å›¾è¡¨ç»„ä»¶æ•°æ®éªŒè¯:', chartValid);
                        return chartValid;
                    case 'left-right-component':
                        const comparisonValid = data.title && data.leftSide && data.rightSide;
                        console.log('å¯¹æ¯”ç»„ä»¶æ•°æ®éªŒè¯:', comparisonValid);
                        return comparisonValid;
                    default:
                        console.log('æœªçŸ¥ç»„ä»¶ç±»å‹ï¼Œè·³è¿‡éªŒè¯');
                        return true;
                }
            }

            buildPrompt(userInput, componentType) {
                // ä¼˜å…ˆä½¿ç”¨ä»£ç ä¸­çš„æœ€æ–°æ¨¡æ¿ï¼Œç¡®ä¿æ‰‹åŠ¨ä¿®æ”¹èƒ½ç«‹å³ç”Ÿæ•ˆ
                // åªæœ‰åœ¨æ˜ç¡®ä»è°ƒè¯•å™¨ä¼ é€’ä¸”æ—¶é—´å¾ˆæ–°æ—¶æ‰ä½¿ç”¨è°ƒè¯•å™¨çš„prompt
                let useDebuggerPrompt = false;
                const debuggedPromptData = localStorage.getItem('debuggedPrompt');
                if (debuggedPromptData) {
                    try {
                        const promptConfig = JSON.parse(debuggedPromptData);
                        // åªæœ‰5åˆ†é’Ÿå†…çš„è°ƒè¯•å™¨promptæ‰ä¼šè¢«ä½¿ç”¨ï¼Œè¶…æ—¶åè‡ªåŠ¨ä½¿ç”¨ä»£ç æ¨¡æ¿
                        const fiveMinutes = 5 * 60 * 1000;
                        if (promptConfig.componentType === componentType && 
                            (Date.now() - promptConfig.timestamp) < fiveMinutes) {
                            console.log('ä½¿ç”¨è°ƒè¯•å™¨ä¸­çš„prompt (5åˆ†é’Ÿå†…æœ‰æ•ˆ):', promptConfig.prompt);
                            // æ¸…é™¤localStorageï¼Œé¿å…é‡å¤ä½¿ç”¨
                            localStorage.removeItem('debuggedPrompt');
                            return promptConfig.prompt;
                        } else {
                            // è¶…æ—¶è‡ªåŠ¨æ¸…é™¤
                            localStorage.removeItem('debuggedPrompt');
                            console.log('è°ƒè¯•å™¨promptå·²è¶…æ—¶ï¼Œä½¿ç”¨ä»£ç ä¸­çš„æœ€æ–°æ¨¡æ¿');
                        }
                    } catch (e) {
                        localStorage.removeItem('debuggedPrompt');
                        console.log('è§£æè°ƒè¯•å™¨promptå¤±è´¥ï¼Œä½¿ç”¨ä»£ç ä¸­çš„æœ€æ–°æ¨¡æ¿');
                    }
                }
                
                console.log('ä½¿ç”¨ä»£ç ä¸­çš„Promptæ¨¡æ¿ - ç»„ä»¶ç±»å‹:', componentType);
                
                // é»˜è®¤promptæ¨¡æ¿
                const promptTemplates = {
                    'core-value': `è¯·åŸºäºä»¥ä¸‹ç”¨æˆ·è¾“å…¥ï¼Œç”Ÿæˆå¸¦å›¾æ ‡çš„åˆ—è¡¨ç»„ä»¶JSONæ•°æ®ï¼š

ç”¨æˆ·è¾“å…¥ï¼š${userInput}

è¯·ç”ŸæˆJSONæ ¼å¼çš„æ•°æ®ï¼ŒåŒ…å«ä»¥ä¸‹ç»“æ„ï¼š
{
  "title": "åˆ—è¡¨æ ‡é¢˜",
  "values": [
    {
      "title": "è¦ç‚¹æ ‡é¢˜",
      "description": "è¦ç‚¹è¯¦ç»†æè¿°"
    }
  ]
}

è¦æ±‚ï¼š
1. ä»ç”¨æˆ·è¾“å…¥ä¸­æå–å…³é”®è¦ç‚¹ï¼Œæ¯ä¸ªè¦ç‚¹è¦å…·ä½“ä¸”æœ‰å®ç”¨ä»·å€¼
2. å…³é”®è¦ç‚¹æ•°ç›®è¦æ ¹æ®ç”¨æˆ·è¾“å…¥çš„å†…å®¹å†³å®š
3. è¦ç‚¹æ ‡é¢˜è¦ç®€æ´æ˜äº†
4. æè¿°è¦å…·ä½“è¯´æ˜è¯¥è¦ç‚¹çš„å…·ä½“å†…å®¹ï¼Œæœ‰æ·±åº¦ã€‚
5. è¿”å›çº¯JSONæ ¼å¼ï¼Œä¸è¦åŒ…å«å…¶ä»–æ–‡å­—`,

                    'ai-transform': `è¯·åŸºäºä»¥ä¸‹ç”¨æˆ·è¾“å…¥ï¼Œç”Ÿæˆç®€çº¦åˆ—è¡¨ç»„ä»¶çš„JSONæ•°æ®ï¼š

ç”¨æˆ·è¾“å…¥ï¼š${userInput}

è¯·ç”ŸæˆJSONæ ¼å¼çš„æ•°æ®ï¼ŒåŒ…å«ä»¥ä¸‹ç»“æ„ï¼š
{
  "title": "åˆ—è¡¨æ ‡é¢˜",
  "steps": [
    {
      "title": "è¦ç‚¹æ ‡é¢˜",
      "description": "ç®€æ´çš„æè¿°è¯´æ˜"
    }
  ]
}

è¦æ±‚ï¼š
1. ä»ç”¨æˆ·è¾“å…¥ä¸­åˆ†æå‡ºå‡ ä¸ªè¦ç‚¹ï¼Œæ¯ä¸ªè¦ç‚¹è¦å…·ä½“ä¸”æœ‰æ·±åº¦
2. å…³é”®è¦ç‚¹æ•°ç›®è¦æ ¹æ®ç”¨æˆ·è¾“å…¥çš„å†…å®¹å†³å®š
3. æ¯ä¸ªæ ‡é¢˜è¦ç®€æ´æ˜ç¡®ï¼Œæè¿°è¦ç®€ç»ƒä½†æ¸…æ™°
4. è¿”å›çº¯JSONæ ¼å¼ï¼Œä¸è¦åŒ…å«å…¶ä»–æ–‡å­—`,

                    'table-component': `è¯·åŸºäºä»¥ä¸‹ç”¨æˆ·è¾“å…¥ï¼Œç”Ÿæˆæ•°æ®è¡¨æ ¼ç»„ä»¶çš„JSONæ•°æ®ï¼š

ç”¨æˆ·è¾“å…¥ï¼š${userInput}

è¯·ç”ŸæˆJSONæ ¼å¼çš„æ•°æ®ï¼ŒåŒ…å«ä»¥ä¸‹ç»“æ„ï¼š
{
  "title": "è¡¨æ ¼æ ‡é¢˜",
  "headers": ["åˆ—æ ‡é¢˜1", "åˆ—æ ‡é¢˜2", "åˆ—æ ‡é¢˜3", ...],
  "rows": [
    ["è¡Œ1åˆ—1", "è¡Œ1åˆ—2", "è¡Œ1åˆ—3", ...],
    ["è¡Œ2åˆ—1", "è¡Œ2åˆ—2", "è¡Œ2åˆ—3", ...],
    ...
  ]
}

è¦æ±‚ï¼š
1. è¡¨æ ¼çš„è¡Œæ•°å’Œåˆ—æ•°å®Œå…¨ç”±ç”¨æˆ·è¾“å…¥çš„å†…å®¹å†³å®šï¼Œæ²¡æœ‰å›ºå®šé™åˆ¶
2. æ ¹æ®ç”¨æˆ·è¾“å…¥æ™ºèƒ½åˆ¤æ–­æœ€é€‚åˆçš„è¡¨æ ¼ç»“æ„ï¼ˆå¦‚ï¼š2-10åˆ—ï¼Œ2-15è¡Œï¼‰
3. åˆ—æ ‡é¢˜è¦å‡†ç¡®åæ˜ æ•°æ®ç±»å‹ï¼ˆå¦‚ï¼šå§“åã€å¹´é¾„ã€åœ°åŒºã€é”€é‡ã€ä»·æ ¼ç­‰ï¼‰
4. æ•°æ®å†…å®¹è¦çœŸå®ã€å‡†ç¡®ï¼Œç¬¦åˆç”¨æˆ·è¾“å…¥çš„ä¸»é¢˜
5. å¦‚æœæ˜¯å¯¹æ¯”ç±»å†…å®¹ï¼Œç¬¬ä¸€åˆ—é€šå¸¸æ˜¯å¯¹æ¯”é¡¹ç›®åç§°
6. è¿”å›çº¯JSONæ ¼å¼ï¼Œä¸è¦åŒ…å«å…¶ä»–æ–‡å­—`,

                    'chart-component': `è¯·åŸºäºä»¥ä¸‹ç”¨æˆ·è¾“å…¥ï¼Œç”ŸæˆæŸ±çŠ¶å›¾è¡¨ç»„ä»¶çš„JSONæ•°æ®ï¼š

ç”¨æˆ·è¾“å…¥ï¼š${userInput}

è¯·ç”ŸæˆJSONæ ¼å¼çš„æ•°æ®ï¼ŒåŒ…å«ä»¥ä¸‹ç»“æ„ï¼š
{
  "title": "å›¾è¡¨æ ‡é¢˜",
  "description": "å›¾è¡¨æè¿°è¯´æ˜",
  "unit": "æ•°å€¼å•ä½",
  "chartData": [
    {"category": "æŒ‡æ ‡åç§°1", "value": æ•°å€¼1},
    {"category": "æŒ‡æ ‡åç§°2", "value": æ•°å€¼2}
  ]
}

è¦æ±‚ï¼š
1. ä»ç”¨æˆ·è¾“å…¥ä¸­æå–å‡ ä¸ªå¯é‡åŒ–çš„æŒ‡æ ‡ï¼ŒæŒ‡æ ‡æ•°é‡æ ¹æ®ç”¨æˆ·è¾“å…¥å†³å®šï¼ˆå»ºè®®3-6ä¸ªï¼‰
2. ä¸ºæ¯ä¸ªæŒ‡æ ‡åˆ†é…åˆç†çš„ç»å¯¹æ•°å€¼ï¼ˆä¸æ˜¯ç™¾åˆ†æ¯”ï¼‰
3. æ•°å€¼åº”è¯¥æ˜¯å…·ä½“çš„æ•°é‡ã€é‡‘é¢ã€åˆ†æ•°ç­‰ç»å¯¹å€¼
4. æ ¹æ®æ•°æ®å†…å®¹è‡ªè¡Œåˆ¤æ–­å¹¶è®¾ç½®åˆé€‚çš„å•ä½ï¼ˆå¦‚ï¼šä¸‡å…ƒã€äº¿å…ƒã€ä¸‡äººã€åƒäººã€åˆ†ã€ä¸ªã€å°ã€å¥—ç­‰ï¼‰
5. å•ä½åº”è¯¥æ˜¯ç»å¯¹æ•°å€¼å•ä½ï¼Œä¸è¦ä½¿ç”¨ç™¾åˆ†æ¯”
6. æ•°å€¼è¦ç¬¦åˆå®é™…æƒ…å†µï¼Œå…·æœ‰å‚è€ƒä»·å€¼
7. è¿”å›çº¯JSONæ ¼å¼ï¼Œä¸è¦åŒ…å«å…¶ä»–æ–‡å­—`,

                    'left-right-component': `è¯·åŸºäºä»¥ä¸‹ç”¨æˆ·è¾“å…¥ï¼Œç”Ÿæˆä¼˜åŠ£å¯¹æ¯”ç»„ä»¶çš„JSONæ•°æ®ï¼š

ç”¨æˆ·è¾“å…¥ï¼š${userInput}

è¯·ç”ŸæˆJSONæ ¼å¼çš„æ•°æ®ï¼ŒåŒ…å«ä»¥ä¸‹ç»“æ„ï¼š
{
  "title": "å¯¹æ¯”æ ‡é¢˜",
  "description": "å¯¹æ¯”è¯´æ˜",
  "leftSide": {
    "title": "ä¼˜åŠ¿/æ­£é¢æ ‡é¢˜",
    "icon": "thumbs-up",
    "items": ["ä¼˜åŠ¿1", "ä¼˜åŠ¿2", "ä¼˜åŠ¿3"]
  },
  "rightSide": {
    "title": "åŠ£åŠ¿/è´Ÿé¢æ ‡é¢˜", 
    "icon": "thumbs-down",
    "items": ["åŠ£åŠ¿1", "åŠ£åŠ¿2", "åŠ£åŠ¿3"]
  }
}

è¦æ±‚ï¼š
1. å·¦ä¾§å±•ç¤ºä¼˜åŠ¿ã€å¥½å¤„ã€æ­£é¢è¦ç´ ï¼Œå³ä¾§å±•ç¤ºåŠ£åŠ¿ã€ç¼ºç‚¹ã€è´Ÿé¢è¦ç´ 
2. æ¯ä¾§åˆ—å‡º3-4ä¸ªè¦ç‚¹ï¼Œè¦ç‚¹è¦å…·ä½“æ˜ç¡®
3. å¯¹æ¯”è¦å®¢è§‚çœŸå®ï¼Œæœ‰å®é™…å‚è€ƒä»·å€¼
4. è¿”å›çº¯JSONæ ¼å¼ï¼Œä¸è¦åŒ…å«å…¶ä»–æ–‡å­—`
                };

                return promptTemplates[componentType] || `è¯·åŸºäºç”¨æˆ·è¾“å…¥"${userInput}"ï¼Œä¸º${componentType}ç»„ä»¶ç”Ÿæˆç›¸åº”çš„JSONæ•°æ®ã€‚`;
            }

            generateMockData(userInput, componentType) {
                const mockDataTemplates = {
                    'core-value': {
                        "title": "æ ¸å¿ƒä»·å€¼è§‚",
                        "values": [
                            {"title": "åˆ›æ–°é©±åŠ¨", "description": "æŒç»­æ¨åŠ¨æŠ€æœ¯åˆ›æ–°ï¼Œå¼•é¢†è¡Œä¸šå‘å±•æ–¹å‘ï¼Œä¸ºç”¨æˆ·åˆ›é€ æ›´å¤šä»·å€¼"},
                            {"title": "ç”¨æˆ·è‡³ä¸Š", "description": "å§‹ç»ˆä»¥ç”¨æˆ·éœ€æ±‚ä¸ºä¸­å¿ƒï¼Œæä¾›ä¼˜è´¨çš„äº§å“å’ŒæœåŠ¡ä½“éªŒ"},
                            {"title": "å›¢é˜Ÿåä½œ", "description": "å€¡å¯¼å¼€æ”¾åˆä½œçš„å›¢é˜Ÿæ–‡åŒ–ï¼Œå…±åŒå®ç°æ›´å¤§çš„ç›®æ ‡"},
                            {"title": "è¯šä¿¡è´Ÿè´£", "description": "ç§‰æ‰¿è¯šå®å®ˆä¿¡çš„åŸåˆ™ï¼Œå¯¹æ¯ä¸€ä¸ªæ‰¿è¯ºè´Ÿè´£åˆ°åº•"}
                        ]
                    },
                    'ai-transform': {
                        "title": "å…³é”®æµç¨‹æ­¥éª¤",
                        "steps": [
                            {"title": "ç¬¬ä¸€æ­¥", "description": "åˆ†æå½“å‰æƒ…å†µï¼Œæ˜ç¡®ç›®æ ‡å’Œéœ€æ±‚"},
                            {"title": "ç¬¬äºŒæ­¥", "description": "åˆ¶å®šè¯¦ç»†çš„æ‰§è¡Œè®¡åˆ’å’Œæ—¶é—´å®‰æ’"}
                        ]
                    },
                    'table-component': {
                        "title": "åŠŸèƒ½å¯¹æ¯”åˆ†æ",
                        "headers": ["åŠŸèƒ½ç‰¹æ€§", "åŸºç¡€ç‰ˆ", "ä¸“ä¸šç‰ˆ", "ä¼ä¸šç‰ˆ"],
                        "rows": [
                            ["AIå†…å®¹ç”Ÿæˆ", "æ”¯æŒ", "æ”¯æŒ", "æ”¯æŒ"],
                            ["æ¨¡æ¿æ•°é‡", "10+", "50+", "100+"],
                            ["å¯¼å‡ºæ ¼å¼", "PDF", "PDF/PPT", "å…¨æ ¼å¼"],
                            ["åä½œåŠŸèƒ½", "ä¸æ”¯æŒ", "æ”¯æŒ", "æ”¯æŒ"],
                            ["APIæ¥å£", "ä¸æ”¯æŒ", "ä¸æ”¯æŒ", "æ”¯æŒ"]
                        ]
                    },
                    'chart-component': {
                        "title": "é”€å”®ä¸šç»©ç»Ÿè®¡",
                        "description": "å±•ç¤ºå…³é”®ä¸šåŠ¡æŒ‡æ ‡çš„å…·ä½“æ•°å€¼",
                        "unit": "ä¸‡å…ƒ",
                        "chartData": [
                            {"category": "äº§å“é”€å”®", "value": 1250},
                            {"category": "æœåŠ¡æ”¶å…¥", "value": 850},
                            {"category": "åˆä½œæ”¶ç›Š", "value": 620},
                            {"category": "å…¶ä»–æ”¶å…¥", "value": 380}
                        ]
                    },
                    'left-right-component': {
                        "title": "è§£å†³æ–¹æ¡ˆå¯¹æ¯”",
                        "description": "å¯¹æ¯”ä¸åŒè§£å†³æ–¹æ¡ˆçš„ä¼˜åŠ£åŠ¿ï¼Œä¸ºé€‰æ‹©æä¾›å‚è€ƒ",
                        "leftSide": {
                            "title": "AIè§£å†³æ–¹æ¡ˆä¼˜åŠ¿",
                            "icon": "thumbs-up",
                            "items": ["è‡ªåŠ¨åŒ–ç¨‹åº¦é«˜", "èŠ‚çœäººåŠ›æˆæœ¬", "24å°æ—¶ä¸é—´æ–­æœåŠ¡", "æŒç»­å­¦ä¹ ä¼˜åŒ–"]
                        },
                        "rightSide": {
                            "title": "ä¼ ç»Ÿæ–¹æ¡ˆå±€é™",
                            "icon": "thumbs-down",
                            "items": ["äººå·¥æˆæœ¬é«˜", "æ˜“å‡ºç°é”™è¯¯", "æ•ˆç‡ç›¸å¯¹è¾ƒä½", "éš¾ä»¥æ ‡å‡†åŒ–"]
                        }
                    }
                };

                // æ·±æ‹·è´æ¨¡æ¿æ•°æ®
                let result = JSON.parse(JSON.stringify(mockDataTemplates[componentType]));
                
                // æ™ºèƒ½åˆ†æç”¨æˆ·è¾“å…¥å†…å®¹
                const userInputLower = userInput.toLowerCase();
                const sentences = userInput.split(/[ã€‚ï¼ï¼Ÿ.!?]/).filter(s => s.trim().length > 0);
                
                // æ ¹æ®ç»„ä»¶ç±»å‹å’Œç”¨æˆ·è¾“å…¥æ™ºèƒ½ç”Ÿæˆå†…å®¹
                if (componentType === 'core-value') {
                    // æ ¸å¿ƒä»·å€¼ç»„ä»¶ï¼šä»ç”¨æˆ·è¾“å…¥ä¸­æå–å…³é”®ä»·å€¼ç‚¹
                    if (userInputLower.includes('ai') || userInputLower.includes('äººå·¥æ™ºèƒ½')) {
                        result.title = "AIæ ¸å¿ƒä»·å€¼";
                        result.values = [
                            {"title": "é«˜æ•ˆåˆ›ä½œ", "description": "æå¤§æé«˜å†…å®¹æ–‡æ¡£çš„åˆ¶ä½œæ•ˆç‡ï¼Œå°†å°æ—¶çº§å·¥ä½œç¼©çŸ­è‡³åˆ†é’Ÿçº§"},
                            {"title": "ä¸“ä¸šè®¾è®¡", "description": "æ— éœ€è®¾è®¡æŠ€èƒ½ï¼Œä¹Ÿèƒ½è·å¾—ä¸“ä¸šæ°´å‡†çš„è§†è§‰æ•ˆæœä¸æ’ç‰ˆ"},
                            {"title": "å†…å®¹æ™ºèƒ½åŒ–", "description": "è‡ªåŠ¨ç”Ÿæˆå†…å®¹å¤§çº²ï¼Œæä¾›æ•°æ®å¯è§†åŒ–ä¸å¤šåª’ä½“æ•´åˆ"},
                            {"title": "ä¾¿æ·æ˜“ç”¨", "description": "ç®€åŒ–æ“ä½œæµç¨‹ï¼Œè®©æ¯ä¸ªäººéƒ½èƒ½è½»æ¾åˆ¶ä½œä¸“ä¸šæ¼”ç¤ºæ–‡ç¨¿"}
                        ];
                    } else if (userInputLower.includes('äº§å“') || userInputLower.includes('åŠŸèƒ½')) {
                        result.title = "äº§å“æ ¸å¿ƒä»·å€¼";
                        result.values = [
                            {"title": "åŠŸèƒ½å®Œå–„", "description": "æä¾›å…¨é¢çš„åŠŸèƒ½æ¨¡å—ï¼Œæ»¡è¶³ä¸åŒåœºæ™¯éœ€æ±‚"},
                            {"title": "æ€§èƒ½å“è¶Š", "description": "é«˜æ€§èƒ½å¤„ç†èƒ½åŠ›ï¼Œç¡®ä¿æµç•…çš„ç”¨æˆ·ä½“éªŒ"},
                            {"title": "æ˜“äºä½¿ç”¨", "description": "ç›´è§‚çš„ç•Œé¢è®¾è®¡ï¼Œé™ä½å­¦ä¹ æˆæœ¬"},
                            {"title": "æŒç»­åˆ›æ–°", "description": "ä¸æ–­æ›´æ–°ä¼˜åŒ–ï¼Œä¿æŒè¡Œä¸šé¢†å…ˆåœ°ä½"}
                        ];
                    } else {
                        // æ™ºèƒ½ä»ç”¨æˆ·è¾“å…¥ä¸­æå–å…³é”®è¯ä½œä¸ºä»·å€¼ç‚¹ï¼ŒåŠ¨æ€å†³å®šæ•°é‡
                        const keywords = this.extractKeywords(userInput);
                        if (keywords.length >= 1) {
                            result.title = this.generateTitleFromKeywords(keywords);
                            
                            // æ ¹æ®å†…å®¹å¤æ‚åº¦æ™ºèƒ½å†³å®šé¡¹æ•°
                            const itemCount = this.determineOptimalItemCount(userInput, keywords);
                            result.values = this.generateValuesFromKeywords(keywords, userInput, itemCount);
                        } else {
                            // å¦‚æœæ²¡æœ‰æ˜ç¡®å…³é”®è¯ï¼Œæ ¹æ®è¾“å…¥é•¿åº¦å’Œå¤æ‚åº¦ç”Ÿæˆ
                            const sentences = userInput.split(/[ã€‚ï¼ï¼Ÿ.!?]/).filter(s => s.trim().length > 5);
                            let itemCount = Math.min(Math.max(sentences.length, 2), 6);
                            
                            // å¦‚æœå¥å­å¤ªå°‘ï¼Œå°è¯•æŒ‰é€—å·åˆ†å‰²è·å–æ›´å¤šè¦ç‚¹
                            if (itemCount < 3) {
                                const phrases = userInput.split(/[ï¼Œ,ã€]/).filter(s => s.trim().length > 3);
                                if (phrases.length >= 3) {
                                    itemCount = Math.min(phrases.length, 6);
                                    result.title = "æ ¸å¿ƒè¦ç‚¹";
                                    result.values = phrases.slice(0, itemCount).map((phrase, index) => ({
                                        title: `è¦ç‚¹${index + 1}`,
                                        description: phrase.trim()
                                    }));
                                } else {
                                    result.title = "è¦ç‚¹æ€»ç»“";
                                    result.values = sentences.slice(0, itemCount).map((sentence, index) => ({
                                        title: `è¦ç‚¹${index + 1}`,
                                        description: sentence.trim()
                                    }));
                                }
                            } else {
                                result.title = "è¦ç‚¹æ€»ç»“";
                                result.values = sentences.slice(0, itemCount).map((sentence, index) => ({
                                    title: `è¦ç‚¹${index + 1}`,
                                    description: sentence.trim()
                                }));
                            }
                        }
                    }
                } else if (componentType === 'ai-transform') {
                    // ç®€çº¦åˆ—è¡¨ç»„ä»¶ï¼šæ ¹æ®ç”¨æˆ·è¾“å…¥åŠ¨æ€ç”Ÿæˆæ­¥éª¤ï¼Œä¸é¢„è®¾åœºæ™¯
                    const keywords = this.extractKeywords(userInput);
                    const steps = this.generateStepsFromInput(userInput, keywords);
                    
                    if (steps.length > 0) {
                        result.title = this.generateTitleFromKeywords(keywords) || "ä¸»è¦æ­¥éª¤";
                        result.steps = steps;
                    } else {
                        // å¦‚æœæ— æ³•ç”Ÿæˆæ­¥éª¤ï¼Œä½¿ç”¨é€šç”¨æ ¼å¼
                        result.title = "å…³é”®è¦ç‚¹";
                        result.steps = [
                            {"title": "è¦ç‚¹1", "description": "è¯·æä¾›æ›´è¯¦ç»†çš„å†…å®¹ä»¥ç”Ÿæˆç›¸å…³æ­¥éª¤"},
                            {"title": "è¦ç‚¹2", "description": "ç³»ç»Ÿå°†æ ¹æ®æ‚¨çš„è¾“å…¥æ™ºèƒ½åˆ†æå¹¶ç”Ÿæˆå¯¹åº”å†…å®¹"}
                        ];
                    }
                } else if (componentType === 'table-component') {
                    // è¡¨æ ¼ç»„ä»¶ï¼šæ ¹æ®ç”¨æˆ·è¾“å…¥åŠ¨æ€ç”Ÿæˆè¡¨æ ¼ç»“æ„
                    if (userInputLower.includes('äººå£') || userInputLower.includes('å›½å®¶')) {
                        result.title = "ä¸–ç•Œä¸»è¦å›½å®¶äººå£æ•°æ®";
                        result.headers = ["å›½å®¶", "äººå£(äº¿)", "å¢é•¿ç‡(%)", "åŸé•‡åŒ–ç‡(%)", "äººå£å¯†åº¦(äºº/kmÂ²)"];
                        result.rows = [
                            ["ä¸­å›½", "14.1", "0.3", "63.9", "148"],
                            ["å°åº¦", "13.8", "1.0", "35.4", "464"],
                            ["ç¾å›½", "3.3", "0.4", "82.7", "36"],
                            ["å°å°¼", "2.7", "1.1", "56.0", "151"],
                            ["å·´è¥¿", "2.1", "0.8", "87.1", "25"]
                        ];
                    } else if (userInputLower.includes('é”€å”®') || userInputLower.includes('ä¸šç»©')) {
                        result.title = "å­£åº¦é”€å”®ä¸šç»©ç»Ÿè®¡";
                        result.headers = ["åœ°åŒº", "Q1é”€å”®é¢", "Q2é”€å”®é¢", "Q3é”€å”®é¢", "Q4é”€å”®é¢", "å¹´åº¦æ€»è®¡", "å¢é•¿ç‡"];
                        result.rows = [
                            ["åä¸œ", "1200ä¸‡", "1350ä¸‡", "1480ä¸‡", "1620ä¸‡", "5650ä¸‡", "+15%"],
                            ["åå—", "980ä¸‡", "1100ä¸‡", "1250ä¸‡", "1380ä¸‡", "4710ä¸‡", "+12%"],
                            ["ååŒ—", "1050ä¸‡", "1180ä¸‡", "1290ä¸‡", "1420ä¸‡", "4940ä¸‡", "+18%"]
                        ];
                    } else if (userInputLower.includes('å­¦æ ¡') || userInputLower.includes('æ•™è‚²')) {
                        result.title = "å­¦æ ¡æ•™è‚²æ•°æ®ç»Ÿè®¡";
                        result.headers = ["å­¦æ ¡åç§°", "å­¦ç”Ÿäººæ•°", "æ•™å¸ˆäººæ•°", "å¸ˆç”Ÿæ¯”", "å‡å­¦ç‡"];
                        result.rows = [
                            ["ç¬¬ä¸€ä¸­å­¦", "2400", "180", "1:13", "98.5%"],
                            ["å®éªŒä¸­å­¦", "2100", "165", "1:13", "96.8%"],
                            ["å¤–å›½è¯­å­¦æ ¡", "1800", "150", "1:12", "99.2%"],
                            ["èŒä¸šæŠ€æœ¯å­¦æ ¡", "3200", "220", "1:15", "85.6%"]
                        ];
                    } else if (userInputLower.includes('äº§å“') || userInputLower.includes('åŠŸèƒ½')) {
                        result.title = "äº§å“åŠŸèƒ½å¯¹æ¯”";
                        result.headers = ["åŠŸèƒ½ç‰¹æ€§", "åŸºç¡€ç‰ˆ", "ä¸“ä¸šç‰ˆ", "ä¼ä¸šç‰ˆ"];
                        result.rows = [
                            ["ç”¨æˆ·æ•°é‡é™åˆ¶", "10äºº", "100äºº", "æ— é™åˆ¶"],
                            ["å­˜å‚¨ç©ºé—´", "1GB", "10GB", "100GB"],
                            ["æŠ€æœ¯æ”¯æŒ", "ç¤¾åŒº", "é‚®ä»¶", "ä¸“çº¿"],
                            ["APIè°ƒç”¨", "1000æ¬¡/æœˆ", "10000æ¬¡/æœˆ", "æ— é™åˆ¶"]
                        ];
                    } else {
                        // æ ¹æ®ç”¨æˆ·è¾“å…¥ç”ŸæˆåŠ¨æ€è¡¨æ ¼
                        const keywords = this.extractKeywords(userInput);
                        if (keywords.length >= 1) {
                            const mainKeyword = keywords[0];
                            // æ ¹æ®å…³é”®è¯æ•°é‡å†³å®šåˆ—æ•°
                            const columnCount = Math.min(Math.max(keywords.length + 1, 3), 6);
                            
                            result.title = `${mainKeyword}æ•°æ®ç»Ÿè®¡è¡¨`;
                            result.headers = ["é¡¹ç›®"];
                            
                            // åŠ¨æ€ç”Ÿæˆåˆ—æ ‡é¢˜
                            for (let i = 1; i < columnCount; i++) {
                                result.headers.push(keywords[i-1] || `æŒ‡æ ‡${i}`);
                            }
                            
                            // åŠ¨æ€ç”Ÿæˆè¡Œæ•°æ®
                            result.rows = [];
                            const rowCount = Math.min(Math.max(keywords.length, 3), 8);
                            for (let i = 0; i < rowCount; i++) {
                                const row = [`é¡¹ç›®${i+1}`];
                                for (let j = 1; j < columnCount; j++) {
                                    row.push(`æ•°æ®${i+1}-${j}`);
                                }
                                result.rows.push(row);
                            }
                        }
                    }
                } else if (componentType === 'chart-component') {
                    // å›¾è¡¨ç»„ä»¶ï¼šæ ¹æ®ç”¨æˆ·è¾“å…¥ç”Ÿæˆæ•°æ®ï¼Œè®©å¤§æ¨¡å‹è‡ªè¡Œåˆ¤æ–­å•ä½
                    const keywords = this.extractKeywords(userInput);
                    if (keywords.length >= 1) {
                        const mainKeyword = keywords[0];
                        result.title = `${mainKeyword}æ•°æ®ç»Ÿè®¡`;
                        result.description = `å±•ç¤º${mainKeyword}ç›¸å…³çš„å…³é”®æ•°æ®æŒ‡æ ‡`;
                        
                        // ç”ŸæˆåŸºç¡€æ•°æ®ï¼Œè®©å¤§æ¨¡å‹æˆ–ç”¨æˆ·è¾“å…¥å†³å®šå…·ä½“å•ä½å’Œæ•°å€¼
                        result.chartData = keywords.slice(0, Math.min(keywords.length, 6)).map((keyword, index) => ({
                            category: keyword,
                            value: 100 + Math.floor(Math.random() * 500) // ç”Ÿæˆ100-600ä¹‹é—´çš„éšæœºæ•°å€¼
                        }));
                        
                        // é»˜è®¤ä½¿ç”¨é€šç”¨å•ä½ï¼Œå®é™…åº”è¯¥ç”±AIå¤§æ¨¡å‹åˆ¤æ–­
                        result.unit = "ä¸ª";
                    }
                } else if (componentType === 'left-right-component') {
                    // å·¦å³å¯¹æ¯”ç»„ä»¶ï¼šæ ¹æ®ç”¨æˆ·è¾“å…¥ç”Ÿæˆå¯¹æ¯”å†…å®¹
                    if (userInputLower.includes('ai') || userInputLower.includes('ä¼ ç»Ÿ')) {
                        result.title = "AI vs ä¼ ç»Ÿåˆ¶ä½œæ–¹å¼";
                        result.leftSide = {
                            "title": "AIåˆ¶ä½œæ–¹å¼",
                            "icon": "thumbs-up",
                            "items": ["æå¤§æé«˜æ•ˆç‡", "è‡ªåŠ¨ç”Ÿæˆå†…å®¹", "æ™ºèƒ½è®¾è®¡å»ºè®®", "ä¸€é”®ç”Ÿæˆæˆå“"]
                        };
                        result.rightSide = {
                            "title": "ä¼ ç»Ÿåˆ¶ä½œæ–¹å¼",
                            "icon": "thumbs-down",
                            "items": ["è€—æ—¶è¾ƒé•¿", "æ‰‹åŠ¨ç¼–è¾‘", "éœ€è¦è®¾è®¡æŠ€èƒ½", "é‡å¤æ€§å·¥ä½œå¤š"]
                        };
                    } else if (userInputLower.includes('ç§»æ°‘')) {
                        result.title = "ç§»æ°‘ä¼˜åŠ£åŠ¿åˆ†æ";
                        result.leftSide = {
                            "title": "ä¼˜åŠ¿æ–¹",
                            "icon": "thumbs-up",
                            "items": ["æ‹“å±•å°±ä¸šæœºä¼šå’Œå‘å±•ç©ºé—´", "æ¥è§¦å¤šå…ƒæ–‡åŒ–æå‡è§†é‡", "äº«å—æ›´å¥½çš„æ•™è‚²åŒ»ç–—èµ„æº", "ä¸ºä¸‹ä¸€ä»£æä¾›æ›´å¤šæœºä¼š"]
                        };
                        result.rightSide = {
                            "title": "åŠ£åŠ¿æ–¹",
                            "icon": "thumbs-down",
                            "items": ["è¯­è¨€æ–‡åŒ–é€‚åº”æŒ‘æˆ˜", "è¿œç¦»å®¶äººæœ‹å‹æ”¯æŒç½‘ç»œ", "åˆæœŸç»æµå‹åŠ›è¾ƒå¤§", "èŒä¸šè®¤è¯å’Œé‡æ–°èµ·æ­¥å›°éš¾"]
                        };
                    } else if (userInputLower.includes('æ—…æ¸¸')) {
                        result.title = "æ—…æ¸¸ä¼˜åŠ£åŠ¿åˆ†æ";
                        result.leftSide = {
                            "title": "æ—…æ¸¸ä¼˜åŠ¿",
                            "icon": "thumbs-up",
                            "items": ["å¼€é˜”çœ¼ç•Œå¢é•¿è§è¯†", "é‡Šæ”¾å‹åŠ›æ”¾æ¾èº«å¿ƒ", "ä½“éªŒä¸åŒæ–‡åŒ–é£æƒ…", "å¢è¿›äººé™…å…³ç³»äº¤æµ"]
                        };
                        result.rightSide = {
                            "title": "æ—…æ¸¸åŠ£åŠ¿",
                            "icon": "thumbs-down",
                            "items": ["é«˜é¢è´¹ç”¨ç»æµè´Ÿæ‹…", "æ—¶é—´å®‰æ’å—åˆ°é™åˆ¶", "æ—…é€”ç–²åŠ³èº«å¿ƒæ¶ˆè€—", "å®‰å…¨é£é™©ä¸ç¡®å®šæ€§"]
                        };
                    } else {
                        // æ ¹æ®ç”¨æˆ·è¾“å…¥çš„å…³é”®è¯ç”Ÿæˆé€šç”¨å¯¹æ¯”å†…å®¹
                        const keywords = this.extractKeywords(userInput);
                        if (keywords.length >= 1) {
                            const mainKeyword = keywords[0];
                            result.title = `${mainKeyword}ä¼˜åŠ£åŠ¿åˆ†æ`;
                            result.leftSide = {
                                "title": "ä¼˜åŠ¿æ–¹é¢",
                                "icon": "thumbs-up",
                                "items": [`${mainKeyword}çš„ä¸»è¦ä¼˜åŠ¿1`, `${mainKeyword}çš„ä¸»è¦ä¼˜åŠ¿2`, `${mainKeyword}çš„ä¸»è¦ä¼˜åŠ¿3`]
                            };
                            result.rightSide = {
                                "title": "åŠ£åŠ¿æ–¹é¢",
                                "icon": "thumbs-down",
                                "items": [`${mainKeyword}çš„ä¸»è¦åŠ£åŠ¿1`, `${mainKeyword}çš„ä¸»è¦åŠ£åŠ¿2`, `${mainKeyword}çš„ä¸»è¦åŠ£åŠ¿3`]
                            };
                        }
                    }
                }

                return result;
            }

            // ä»ç”¨æˆ·è¾“å…¥ä¸­æå–å…³é”®è¯
            extractKeywords(text) {
                const keywords = [];
                const commonWords = ['çš„', 'æ˜¯', 'æœ‰', 'åœ¨', 'ä¸', 'å’Œ', 'æˆ–', 'ä½†', 'ä¹Ÿ', 'éƒ½', 'èƒ½', 'ä¼š', 'è¦', 'è®©', 'ä½¿', 'ä¸º', 'äº†', 'ä»', 'æŠŠ', 'è¢«', 'ç»™', 'å¯¹', 'å‘', 'ä¸Š', 'ä¸‹', 'ä¸­', 'æ¥', 'å»', 'å‡º', 'å…¥', 'è¿‡', 'èµ·', 'å¼€', 'å…³', 'æˆ', 'åˆ°', 'ç€', 'äº†', 'çš„', 'å¾—', 'åœ°'];
                
                // åˆ†è¯å¹¶è¿‡æ»¤
                const words = text.split(/[ï¼Œã€‚ï¼ï¼Ÿã€ï¼›ï¼š""''ï¼ˆï¼‰ã€ã€‘ã€Šã€‹\s]+/).filter(word => 
                    word.length > 1 && !commonWords.includes(word) && !/^\d+$/.test(word)
                );
                
                // è¿”å›å‰å‡ ä¸ªå…³é”®è¯
                return words.slice(0, 8); // å¢åŠ åˆ°8ä¸ªå…³é”®è¯ä»¥æ”¯æŒæ›´å¤šé¡¹
            }

            // æ ¹æ®å…³é”®è¯ç”Ÿæˆåˆé€‚çš„æ ‡é¢˜
            generateTitleFromKeywords(keywords) {
                const firstKeyword = keywords[0];
                if (keywords.some(k => k.includes('ä¼˜åŠ¿') || k.includes('ä»·å€¼') || k.includes('ç‰¹ç‚¹'))) {
                    return `${firstKeyword}æ ¸å¿ƒä¼˜åŠ¿`;
                } else if (keywords.some(k => k.includes('åŠŸèƒ½') || k.includes('ç‰¹è‰²') || k.includes('èƒ½åŠ›'))) {
                    return `${firstKeyword}ä¸»è¦åŠŸèƒ½`;
                } else if (keywords.some(k => k.includes('æµç¨‹') || k.includes('æ­¥éª¤') || k.includes('æ–¹æ³•'))) {
                    return `${firstKeyword}å…³é”®è¦ç‚¹`;
                } else if (keywords.some(k => k.includes('è®¡åˆ’') || k.includes('æ–¹æ¡ˆ') || k.includes('ç­–ç•¥'))) {
                    return `${firstKeyword}å®æ–½æ–¹æ¡ˆ`;
                } else if (keywords.some(k => k.includes('è¿‡ç¨‹') || k.includes('é˜¶æ®µ') || k.includes('ç¯èŠ‚'))) {
                    return `${firstKeyword}æ‰§è¡Œæ­¥éª¤`;
                } else if (keywords.some(k => k.includes('è¦æ±‚') || k.includes('æ ‡å‡†') || k.includes('åŸåˆ™'))) {
                    return `${firstKeyword}æ ¸å¿ƒè¦æ±‚`;
                } else if (keywords.some(k => k.includes('æ•™è‚²') || k.includes('å­¦ä¹ ') || k.includes('åŸ¹è®­'))) {
                    return `${firstKeyword}æ ¸å¿ƒè¦ç´ `;
                } else {
                    return `${firstKeyword}é‡ç‚¹å†…å®¹`;
                }
            }

            // æ™ºèƒ½å†³å®šæœ€ä¼˜é¡¹æ•°
            determineOptimalItemCount(userInput, keywords) {
                const textLength = userInput.length;
                const keywordCount = keywords.length;
                const sentences = userInput.split(/[ã€‚ï¼ï¼Ÿ.!?]/).filter(s => s.trim().length > 10);
                const phrases = userInput.split(/[ï¼Œ,ã€]/).filter(s => s.trim().length > 5);
                
                // åŸºäºå¤šä¸ªå› ç´ æ™ºèƒ½å†³å®šé¡¹æ•°
                let baseCount = Math.min(keywordCount, 6); // åŸºç¡€é¡¹æ•°ä¸è¶…è¿‡6ä¸ª
                
                // å¦‚æœå…³é”®è¯å¤ªå°‘ï¼Œè€ƒè™‘å¥å­å’ŒçŸ­è¯­æ•°é‡
                if (baseCount < 3) {
                    baseCount = Math.max(baseCount, Math.min(sentences.length, 4));
                    if (baseCount < 3) {
                        baseCount = Math.max(baseCount, Math.min(phrases.length, 4));
                    }
                }
                
                // æ ¹æ®æ–‡æœ¬é•¿åº¦è°ƒæ•´
                if (textLength > 300) {
                    baseCount = Math.min(baseCount + 2, 6);
                } else if (textLength > 200) {
                    baseCount = Math.min(baseCount + 1, 6);
                } else if (textLength < 50) {
                    baseCount = Math.max(baseCount - 1, 2);
                }
                
                // æ ¹æ®å¥å­æ•°é‡è°ƒæ•´
                if (sentences.length >= 6) {
                    baseCount = Math.min(baseCount + 1, 6);
                } else if (sentences.length <= 1) {
                    baseCount = Math.max(baseCount - 1, 2);
                }
                
                // ç¡®ä¿é¡¹æ•°åœ¨åˆç†èŒƒå›´å†…ï¼ˆ2-6é¡¹ï¼‰
                return Math.min(Math.max(baseCount, 2), 6);
            }

            // æ ¹æ®å…³é”®è¯å’Œè¾“å…¥å†…å®¹ç”Ÿæˆä»·å€¼ç‚¹
            generateValuesFromKeywords(keywords, userInput, itemCount) {
                const values = [];
                const sentences = userInput.split(/[ã€‚ï¼ï¼Ÿ.!?]/).filter(s => s.trim().length > 10);
                const phrases = userInput.split(/[ï¼Œ,ã€]/).filter(s => s.trim().length > 5);
                
                // é¦–å…ˆä½¿ç”¨å…³é”®è¯
                for (let i = 0; i < itemCount && i < keywords.length; i++) {
                    const keyword = keywords[i];
                    let description = '';
                    
                    // å°è¯•ä»åŸæ–‡ä¸­æ‰¾åˆ°ç›¸å…³çš„å¥å­ä½œä¸ºæè¿°
                    const relatedSentence = sentences.find(s => s.includes(keyword));
                    if (relatedSentence) {
                        description = relatedSentence.trim();
                    } else {
                        // æŸ¥æ‰¾åŒ…å«è¯¥å…³é”®è¯çš„çŸ­è¯­
                        const relatedPhrase = phrases.find(p => p.includes(keyword));
                        if (relatedPhrase) {
                            description = relatedPhrase.trim();
                        } else {
                            // ç”Ÿæˆé€šç”¨æè¿°
                            description = this.generateDescriptionForKeyword(keyword, userInput);
                        }
                    }
                    
                    values.push({
                        title: keyword,
                        description: description
                    });
                }
                
                // å¦‚æœå…³é”®è¯ä¸å¤Ÿï¼Œç”¨å¥å­è¡¥å……
                while (values.length < itemCount && values.length < sentences.length) {
                    const sentenceIndex = values.length;
                    const sentence = sentences[sentenceIndex];
                    if (sentence && sentence.trim().length > 10) {
                        // å°è¯•ä»å¥å­ä¸­æå–æ ‡é¢˜
                        const words = sentence.split(/[\sï¼Œ,ã€ï¼š:]/).filter(w => w.length > 1 && w.length < 10);
                        const title = words.length > 0 ? words[0] : `è¦ç‚¹${values.length + 1}`;
                        
                        values.push({
                            title: title,
                            description: sentence.trim()
                        });
                    } else {
                        break;
                    }
                }
                
                // å¦‚æœè¿˜æ˜¯ä¸å¤Ÿï¼Œç”¨çŸ­è¯­è¡¥å……
                while (values.length < itemCount && values.length < phrases.length) {
                    const phraseIndex = values.length;
                    const phrase = phrases[phraseIndex];
                    if (phrase && phrase.trim().length > 5) {
                        values.push({
                            title: `è¦ç‚¹${values.length + 1}`,
                            description: phrase.trim()
                        });
                    } else {
                        break;
                    }
                }
                
                return values;
            }

            // ä¸ºå…³é”®è¯ç”Ÿæˆæè¿°
            generateDescriptionForKeyword(keyword, context) {
                const contextLower = context.toLowerCase();
                
                if (contextLower.includes('ai') || contextLower.includes('äººå·¥æ™ºèƒ½')) {
                    return `é€šè¿‡${keyword}æŠ€æœ¯æå‡å·¥ä½œæ•ˆç‡ï¼Œå®ç°æ™ºèƒ½åŒ–å¤„ç†å’Œè‡ªåŠ¨åŒ–æ“ä½œ`;
                } else if (contextLower.includes('äº§å“') || contextLower.includes('åŠŸèƒ½')) {
                    return `${keyword}ä½œä¸ºæ ¸å¿ƒåŠŸèƒ½ï¼Œä¸ºç”¨æˆ·æä¾›ä¸“ä¸šå¯é çš„äº§å“ä½“éªŒ`;
                } else if (contextLower.includes('æ•™è‚²') || contextLower.includes('å­¦ä¹ ')) {
                    return `${keyword}åœ¨æ•™è‚²é¢†åŸŸå‘æŒ¥é‡è¦ä½œç”¨ï¼Œä¿ƒè¿›å­¦ä¹ æ•ˆæœæå‡`;
                } else if (contextLower.includes('ç®¡ç†') || contextLower.includes('ä¼ä¸š')) {
                    return `${keyword}å¸®åŠ©ä¼ä¸šä¼˜åŒ–ç®¡ç†æµç¨‹ï¼Œæé«˜è¿è¥æ•ˆç‡`;
                } else if (contextLower.includes('æŠ€æœ¯') || contextLower.includes('åˆ›æ–°')) {
                    return `${keyword}ä»£è¡¨äº†æŠ€æœ¯åˆ›æ–°çš„é‡è¦æ–¹å‘ï¼Œæ¨åŠ¨è¡Œä¸šå‘å±•`;
                } else {
                    return `${keyword}æ˜¯å…³é”®è¦ç´ ï¼Œå¯¹æ•´ä½“ç›®æ ‡çš„å®ç°å…·æœ‰é‡è¦æ„ä¹‰`;
                }
            }

            // ä»ç”¨æˆ·è¾“å…¥ç”Ÿæˆæµç¨‹æ­¥éª¤ï¼Œæ”¯æŒåŠ¨æ€é¡¹æ•°
            generateStepsFromInput(text, keywords = []) {
                const steps = [];
                const sentences = text.split(/[ã€‚ï¼ï¼Ÿ.!?]/).filter(s => s.trim().length > 10);
                const phrases = text.split(/[ï¼Œ,ã€]/).filter(s => s.trim().length > 5);
                
                // æ™ºèƒ½å†³å®šæ­¥éª¤æ•°é‡ï¼ˆ2-6ä¸ªï¼‰
                const optimalCount = this.determineOptimalItemCount(text, keywords);
                
                // ä¼˜å…ˆä½¿ç”¨å…³é”®è¯ç”Ÿæˆæ­¥éª¤
                for (let i = 0; i < optimalCount && i < keywords.length; i++) {
                    const keyword = keywords[i];
                    let description = '';
                    
                    // å°è¯•ä»åŸæ–‡ä¸­æ‰¾åˆ°ç›¸å…³çš„å¥å­ä½œä¸ºæè¿°
                    const relatedSentence = sentences.find(s => s.includes(keyword));
                    if (relatedSentence) {
                        description = relatedSentence.trim();
                    } else {
                        // æŸ¥æ‰¾åŒ…å«è¯¥å…³é”®è¯çš„çŸ­è¯­
                        const relatedPhrase = phrases.find(p => p.includes(keyword));
                        if (relatedPhrase) {
                            description = relatedPhrase.trim();
                        } else {
                            // ç”Ÿæˆé€šç”¨æè¿°
                            description = this.generateDescriptionForKeyword(keyword, text);
                        }
                    }
                    
                    steps.push({
                        title: keyword,
                        description: description
                    });
                }
                
                // å¦‚æœå…³é”®è¯ä¸å¤Ÿï¼Œç”¨å¥å­è¡¥å……
                while (steps.length < optimalCount && steps.length < sentences.length) {
                    const sentenceIndex = steps.length;
                    const sentence = sentences[sentenceIndex];
                    if (sentence && sentence.trim().length > 10) {
                        // å°è¯•ä»å¥å­ä¸­æå–æ ‡é¢˜
                        const words = sentence.split(/[\sï¼Œ,ã€ï¼š:]/).filter(w => w.length > 1 && w.length < 15);
                        const title = words.length > 0 ? words[0] : `æ­¥éª¤${steps.length + 1}`;
                        
                        steps.push({
                            title: title,
                            description: sentence.trim()
                        });
                    } else {
                        break;
                    }
                }
                
                // å¦‚æœè¿˜æ˜¯ä¸å¤Ÿï¼Œç”¨çŸ­è¯­è¡¥å……
                while (steps.length < optimalCount && steps.length < phrases.length) {
                    const phraseIndex = steps.length;
                    const phrase = phrases[phraseIndex];
                    if (phrase && phrase.trim().length > 5) {
                        steps.push({
                            title: `è¦ç‚¹${steps.length + 1}`,
                            description: phrase.trim()
                        });
                    } else {
                        break;
                    }
                }
                
                return steps;
            }

            renderPreview() {
                if (!this.generatedContent || !this.selectedComponent) return;

                const previewArea = document.getElementById('previewArea');
                
                // å…ˆåˆ›å»ºiframeï¼Œç„¶åç›‘å¬loadäº‹ä»¶æ¥å‘é€æ¶ˆæ¯
                const iframe = document.createElement('iframe');
                iframe.id = 'component-iframe';
                iframe.src = `${this.selectedComponent}.html`;
                iframe.style.width = '100%';
                iframe.style.height = '100%';
                iframe.style.border = 'none';
                iframe.style.borderRadius = '8px';
                
                // ç›‘å¬iframeåŠ è½½å®Œæˆäº‹ä»¶
                iframe.onload = () => {
                    console.log('å‘é€æ•°æ®åˆ°ç»„ä»¶:', this.selectedComponent, this.generatedContent);
                    console.log('è¯¦ç»†çš„ç”Ÿæˆå†…å®¹:', JSON.stringify(this.generatedContent, null, 2));
                    // ç­‰å¾…iframeå®Œå…¨åŠ è½½åå†å‘é€æ¶ˆæ¯
                    setTimeout(() => {
                        iframe.contentWindow.postMessage({
                            type: 'updateContent',
                            component: this.selectedComponent,
                            content: this.generatedContent
                        }, '*');
                    }, 100);
                };
                
                // æ¸…ç©ºé¢„è§ˆåŒºåŸŸå¹¶æ·»åŠ æ–°çš„iframe
                previewArea.innerHTML = '';
                previewArea.appendChild(iframe);
            }

            renderCoreValuePreview() {
                const { title, values } = this.generatedContent;
                return `
                    <div class="generated-preview" id="preview-content">
                        <div class="preview-header">
                            <h1 class="preview-title">${title}</h1>
                        </div>
                        <div class="values-container">
                            ${values.map((value, index) => `
                                <div class="value-item">
                                    <div class="value-icon">
                                        <i class="fas fa-star"></i>
                                    </div>
                                    <div class="value-content">
                                        <h3 class="value-title">${value.title}</h3>
                                        <p class="value-description">${value.description}</p>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }

            renderAiTransformPreview() {
                const { title, steps } = this.generatedContent;
                return `
                    <div class="generated-preview" id="preview-content">
                        <div class="preview-header">
                            <h1 class="preview-title">${title}</h1>
                        </div>
                        <div class="steps-container">
                            ${steps.map((step, index) => `
                                <div class="step-item">
                                    <div class="step-indicator">
                                        <span class="step-number">${index + 1}</span>
                                    </div>
                                    <div class="step-content">
                                        <h3 class="step-title">${step.title}</h3>
                                        <p class="step-description">${step.description}</p>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }

            renderTablePreview() {
                const { title, headers, rows } = this.generatedContent;
                return `
                    <div class="generated-preview" id="preview-content">
                        <div class="preview-header">
                            <h1 class="preview-title">${title}</h1>
                        </div>
                        <div class="table-container">
                            <table class="preview-table">
                                <thead>
                                    <tr>
                                        ${headers.map(header => `<th>${header}</th>`).join('')}
                                    </tr>
                                </thead>
                                <tbody>
                                    ${rows.map(row => `
                                        <tr>
                                            ${row.map(cell => `<td>${cell}</td>`).join('')}
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
            }

            renderChartPreview() {
                const { title } = this.generatedContent;
                return `
                    <div class="generated-preview" id="preview-content">
                        <div class="preview-header">
                            <h1 class="preview-title">${title}</h1>
                        </div>
                        <div class="chart-container">
                            <div id="chart-area" style="width: 100%; height: 300px;"></div>
                        </div>
                    </div>
                `;
            }

            renderLeftRightPreview() {
                const { title, left, right } = this.generatedContent;
                return `
                    <div class="generated-preview" id="preview-content">
                        <div class="preview-header">
                            <h1 class="preview-title">${title}</h1>
                        </div>
                        <div class="comparison-container">
                            <div class="comparison-side left-side">
                                <h3 class="side-title">${left.title}</h3>
                                <ul class="side-list">
                                    ${left.items.map(item => `
                                        <li class="side-item">
                                            <i class="fas fa-check"></i>
                                            <span>${item}</span>
                                        </li>
                                    `).join('')}
                                </ul>
                            </div>
                            <div class="comparison-divider"></div>
                            <div class="comparison-side right-side">
                                <h3 class="side-title">${right.title}</h3>
                                <ul class="side-list">
                                    ${right.items.map(item => `
                                        <li class="side-item">
                                            <i class="fas fa-times"></i>
                                            <span>${item}</span>
                                        </li>
                                    `).join('')}
                                </ul>
                            </div>
                        </div>
                    </div>
                `;
            }

            renderD3Chart() {
                if (!this.generatedContent.data) return;

                const chartData = this.generatedContent.data;
                const container = document.getElementById('chart-area');
                
                // æ¸…é™¤ä¹‹å‰çš„å›¾è¡¨
                d3.select('#chart-area').selectAll('*').remove();

                const width = container.clientWidth;
                const height = container.clientHeight;
                const margin = {top: 20, right: 20, bottom: 40, left: 40};
                const innerWidth = width - margin.left - margin.right;
                const innerHeight = height - margin.top - margin.bottom;

                const svg = d3.select('#chart-area')
                    .append('svg')
                    .attr('width', width)
                    .attr('height', height);

                const g = svg.append('g')
                    .attr('transform', `translate(${margin.left},${margin.top})`);

                const x = d3.scaleBand()
                    .domain(chartData.map(d => d.category))
                    .range([0, innerWidth])
                    .padding(0.3);

                const y = d3.scaleLinear()
                    .domain([0, d3.max(chartData, d => d.value)])
                    .range([innerHeight, 0]);

                // æ·»åŠ åæ ‡è½´
                g.append('g')
                    .attr('transform', `translate(0,${innerHeight})`)
                    .call(d3.axisBottom(x))
                    .selectAll('text')
                    .attr('fill', '#e2e8f0')
                    .style('font-size', '12px');

                g.append('g')
                    .call(d3.axisLeft(y).ticks(5))
                    .selectAll('text')
                    .attr('fill', '#e2e8f0')
                    .style('font-size', '12px');

                // æ·»åŠ æŸ±çŠ¶å›¾
                g.selectAll('.bar')
                    .data(chartData)
                    .enter().append('rect')
                    .attr('class', 'bar')
                    .attr('x', d => x(d.category))
                    .attr('y', d => y(d.value))
                    .attr('width', x.bandwidth())
                    .attr('height', d => innerHeight - y(d.value))
                    .attr('fill', '#3b82f6')
                    .attr('rx', 4)
                    .attr('ry', 4);

                // æ·»åŠ æ•°å€¼æ ‡ç­¾
                g.selectAll('.label')
                    .data(chartData)
                    .enter().append('text')
                    .attr('class', 'label')
                    .attr('x', d => x(d.category) + x.bandwidth() / 2)
                    .attr('y', d => y(d.value) - 5)
                    .attr('text-anchor', 'middle')
                    .attr('fill', '#e2e8f0')
                    .style('font-size', '12px')
                    .text(d => d.value);
            }
            
            showDebuggerPromptNotice() {
                // åœ¨é¡µé¢é¡¶éƒ¨æ˜¾ç¤ºä¸€ä¸ªé€šçŸ¥
                const notice = document.createElement('div');
                notice.innerHTML = `
                    <div style="background: rgba(16, 185, 129, 0.2); color: #10b981; padding: 10px 15px; border-radius: 8px; margin-bottom: 15px; border: 1px solid rgba(16, 185, 129, 0.3);">
                        <i class="fas fa-check-circle" style="margin-right: 8px;"></i>
                        æ­£åœ¨ä½¿ç”¨è°ƒè¯•å™¨ä¸­ä¼˜åŒ–çš„Prompt
                    </div>
                `;
                
                // æ’å…¥åˆ°sidebarçš„é¡¶éƒ¨
                const sidebar = document.querySelector('.sidebar');
                sidebar.insertBefore(notice, sidebar.firstChild);
                
                // 5ç§’åç§»é™¤é€šçŸ¥
                setTimeout(() => {
                    notice.remove();
                }, 5000);
            }

            // å›¾ç‰‡è¯†åˆ«åŠŸèƒ½
            async handleImageOCR() {
                const button = document.getElementById('ocrButton');
                const status = document.getElementById('ocrStatus');
                const preview = document.getElementById('imagePreview');
                const userInput = document.getElementById('userInput');

                try {
                    // ç¦ç”¨æŒ‰é’®
                    button.disabled = true;
                    button.innerHTML = '<i class="fas fa-spinner fa-spin"></i><span>æ­£åœ¨è·å–å›¾ç‰‡...</span>';
                    
                    // æ˜¾ç¤ºçŠ¶æ€
                    status.textContent = 'æ­£åœ¨ä»å‰ªè´´æ¿è¯»å–å›¾ç‰‡...';
                    status.className = 'helper-status loading';

                    // æ£€æŸ¥æµè§ˆå™¨æ˜¯å¦æ”¯æŒå‰ªè´´æ¿API
                    if (!navigator.clipboard || !navigator.clipboard.read) {
                        throw new Error('æµè§ˆå™¨ä¸æ”¯æŒå‰ªè´´æ¿APIï¼Œè¯·ä½¿ç”¨Chromeæˆ–Edgeæµè§ˆå™¨');
                    }

                    // ä»å‰ªè´´æ¿è¯»å–å†…å®¹
                    const clipboardItems = await navigator.clipboard.read();
                    let imageBlob = null;

                    // æŸ¥æ‰¾å›¾ç‰‡ç±»å‹çš„å‰ªè´´æ¿å†…å®¹
                    for (const clipboardItem of clipboardItems) {
                        for (const type of clipboardItem.types) {
                            if (type.startsWith('image/')) {
                                imageBlob = await clipboardItem.getType(type);
                                break;
                            }
                        }
                        if (imageBlob) break;
                    }

                    if (!imageBlob) {
                        throw new Error('å‰ªè´´æ¿ä¸­æ²¡æœ‰æ‰¾åˆ°å›¾ç‰‡ï¼Œè¯·å…ˆå¤åˆ¶ä¸€å¼ å›¾ç‰‡');
                    }

                    // æ˜¾ç¤ºå›¾ç‰‡é¢„è§ˆ
                    const imageUrl = URL.createObjectURL(imageBlob);
                    preview.src = imageUrl;
                    preview.style.display = 'block';

                    // æ›´æ–°çŠ¶æ€
                    status.textContent = 'æ­£åœ¨è¯†åˆ«å›¾ç‰‡ä¸­çš„æ–‡å­—...';
                    button.innerHTML = '<i class="fas fa-spinner fa-spin"></i><span>æ­£åœ¨è¯†åˆ«...</span>';

                    // è°ƒç”¨Azure OpenAI Vision APIè¯†åˆ«å›¾ç‰‡
                    const recognizedText = await this.recognizeImageText(imageBlob);

                    // å°†è¯†åˆ«çš„æ–‡å­—å†™å…¥è¾“å…¥æ¡†
                    if (recognizedText) {
                        const currentText = userInput.value.trim();
                        const newText = currentText ? `${currentText}\n\n${recognizedText}` : recognizedText;
                        userInput.value = newText;
                        
                        // æ˜¾ç¤ºæˆåŠŸçŠ¶æ€
                        status.textContent = `æˆåŠŸè¯†åˆ«æ–‡å­—ï¼å·²æ·»åŠ åˆ°è¾“å…¥æ¡† (${recognizedText.length}å­—)`;
                        status.className = 'helper-status success';
                    } else {
                        throw new Error('æœªèƒ½è¯†åˆ«å‡ºæ–‡å­—å†…å®¹');
                    }

                } catch (error) {
                    console.error('å›¾ç‰‡è¯†åˆ«å¤±è´¥:', error);
                    
                    // æ˜¾ç¤ºé”™è¯¯çŠ¶æ€
                    status.textContent = `è¯†åˆ«å¤±è´¥: ${error.message}`;
                    status.className = 'helper-status error';
                    
                    // éšè—å›¾ç‰‡é¢„è§ˆ
                    preview.style.display = 'none';
                    
                } finally {
                    // æ¢å¤æŒ‰é’®çŠ¶æ€
                    button.disabled = false;
                    button.innerHTML = '<i class="fas fa-image"></i><span>ä»å‰ªè´´æ¿å›¾ç‰‡è¯†åˆ«æ–‡å­—</span>';
                    
                    // 3ç§’åéšè—çŠ¶æ€
                    setTimeout(() => {
                        status.style.display = 'none';
                    }, 3000);
                }
            }

            // ä½¿ç”¨Azure OpenAI Vision APIè¯†åˆ«å›¾ç‰‡æ–‡å­—
            async recognizeImageText(imageBlob) {
                // ç¯å¢ƒæ£€æµ‹ï¼šåˆ¤æ–­æ˜¯å¦åœ¨æœ¬åœ°å¼€å‘ç¯å¢ƒ
                const isLocalEnvironment = this.isLocalEnvironment();
                
                if (isLocalEnvironment) {
                    return await this.recognizeImageTextDirect(imageBlob);
                } else {
                    return await this.recognizeImageTextViaProxy(imageBlob);
                }
            }

            // ç›´æ¥è°ƒç”¨Vision APIï¼ˆæœ¬åœ°ç¯å¢ƒï¼‰
            async recognizeImageTextDirect(imageBlob) {
                try {
                    // å°†å›¾ç‰‡è½¬æ¢ä¸ºbase64
                    const base64Image = await this.blobToBase64(imageBlob);
                    
                    console.log('æ­£åœ¨è°ƒç”¨Vision API...', {
                        imageSize: imageBlob.size,
                        imageType: imageBlob.type,
                        base64Length: base64Image.length
                    });
                    
                    // ç›´æ¥è°ƒç”¨Azure OpenAI Vision APIï¼ˆæœ¬åœ°æµ‹è¯•ï¼‰
                    const apiKey = 'af60f8ec72694fc8bbb785f492ae9a02';
                    const endpoint = 'https://hanc04-openai-sweden-central.openai.azure.com/openai/deployments/gpt-4o/chat/completions?api-version=2024-02-01';
                    
                    const requestBody = {
                        messages: [
                            {
                                role: "system",
                                content: "ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„å›¾ç‰‡æ–‡å­—è¯†åˆ«åŠ©æ‰‹ã€‚è¯·ä»”ç»†è¯†åˆ«å›¾ç‰‡ä¸­çš„æ‰€æœ‰æ–‡å­—å†…å®¹ï¼ŒåŒ…æ‹¬ä¸­æ–‡ã€è‹±æ–‡ã€æ•°å­—ç­‰ã€‚è¯·ä¿æŒåŸæœ‰çš„æ ¼å¼å’Œç»“æ„ï¼Œå¦‚æœæ˜¯è¡¨æ ¼è¯·å°½é‡ä¿æŒè¡¨æ ¼æ ¼å¼ã€‚åªè¿”å›è¯†åˆ«å‡ºçš„æ–‡å­—å†…å®¹ï¼Œä¸è¦æ·»åŠ ä»»ä½•è§£é‡Šã€‚"
                            },
                            {
                                role: "user",
                                content: [
                                    {
                                        type: "text",
                                        text: "è¯·è¯†åˆ«è¿™å¼ å›¾ç‰‡ä¸­çš„æ‰€æœ‰æ–‡å­—å†…å®¹ï¼š"
                                    },
                                    {
                                        type: "image_url",
                                        image_url: {
                                            url: base64Image
                                        }
                                    }
                                ]
                            }
                        ],
                        max_tokens: 1000,
                        temperature: 0.1
                    };
                    
                    console.log('å‘é€è¯·æ±‚åˆ°:', endpoint);
                    console.log('è¯·æ±‚ä½“å¤§å°:', JSON.stringify(requestBody).length);
                    
                    const response = await fetch(endpoint, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'api-key': apiKey
                        },
                        body: JSON.stringify(requestBody)
                    });

                    console.log('APIå“åº”çŠ¶æ€:', response.status, response.statusText);
                    
                    if (!response.ok) {
                        const errorText = await response.text();
                        console.error('APIå“åº”é”™è¯¯è¯¦æƒ…:', {
                            status: response.status,
                            statusText: response.statusText,
                            headers: Object.fromEntries(response.headers.entries()),
                            errorText: errorText
                        });
                        
                        // å°è¯•è§£æé”™è¯¯ä¿¡æ¯
                        let errorMessage = `APIè¯·æ±‚å¤±è´¥ (${response.status})`;
                        try {
                            const errorData = JSON.parse(errorText);
                            errorMessage = errorData.error?.message || errorMessage;
                        } catch (e) {
                            errorMessage = errorText || errorMessage;
                        }
                        
                        throw new Error(errorMessage);
                    }

                    const data = await response.json();
                    console.log('APIå“åº”æ•°æ®:', data);
                    
                    if (data.choices && data.choices[0] && data.choices[0].message) {
                        const result = data.choices[0].message.content.trim();
                        console.log('è¯†åˆ«ç»“æœ:', result);
                        return result;
                    } else {
                        console.error('APIè¿”å›æ ¼å¼å¼‚å¸¸:', data);
                        throw new Error('APIè¿”å›æ•°æ®æ ¼å¼é”™è¯¯ï¼Œæœªæ‰¾åˆ°æœ‰æ•ˆçš„è¯†åˆ«ç»“æœ');
                    }
                    
                } catch (error) {
                    console.error('è°ƒç”¨Vision APIå¤±è´¥:', error);
                    
                    // æä¾›æ›´å‹å¥½çš„é”™è¯¯ä¿¡æ¯
                    let friendlyMessage = 'å›¾ç‰‡è¯†åˆ«å¤±è´¥';
                    
                    if (error.message.includes('Failed to fetch')) {
                        friendlyMessage = 'ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥åé‡è¯•';
                    } else if (error.message.includes('401')) {
                        friendlyMessage = 'APIå¯†é’¥æ— æ•ˆæˆ–å·²è¿‡æœŸ';
                    } else if (error.message.includes('403')) {
                        friendlyMessage = 'APIè®¿é—®è¢«æ‹’ç»ï¼Œè¯·æ£€æŸ¥æƒé™è®¾ç½®';
                    } else if (error.message.includes('429')) {
                        friendlyMessage = 'APIè°ƒç”¨é¢‘ç‡é™åˆ¶ï¼Œè¯·ç¨åé‡è¯•';
                    } else if (error.message.includes('500')) {
                        friendlyMessage = 'Azure OpenAIæœåŠ¡æš‚æ—¶ä¸å¯ç”¨ï¼Œè¯·ç¨åé‡è¯•';
                    } else {
                        friendlyMessage = error.message;
                    }
                    
                    throw new Error(friendlyMessage);
                }
            }

            // é€šè¿‡ä»£ç†è°ƒç”¨Vision APIï¼ˆç”Ÿäº§ç¯å¢ƒï¼‰
            async recognizeImageTextViaProxy(imageBlob) {
                try {
                    // å°†å›¾ç‰‡è½¬æ¢ä¸ºbase64
                    const base64Image = await this.blobToBase64(imageBlob);
                    
                    console.log('æ­£åœ¨é€šè¿‡ä»£ç†è°ƒç”¨Vision API...', {
                        imageSize: imageBlob.size,
                        imageType: imageBlob.type,
                        base64Length: base64Image.length
                    });
                    
                    const requestBody = {
                        imageData: base64Image,
                        imageType: imageBlob.type
                    };
                    
                    const response = await fetch('/api/vision', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(requestBody)
                    });

                    console.log('ä»£ç†APIå“åº”çŠ¶æ€:', response.status, response.statusText);
                    
                    if (!response.ok) {
                        const errorText = await response.text();
                        console.error('ä»£ç†APIå“åº”é”™è¯¯:', errorText);
                        throw new Error(`ä»£ç†æœåŠ¡å™¨é”™è¯¯ (${response.status}): ${errorText}`);
                    }

                    const data = await response.json();
                    console.log('é€šè¿‡ä»£ç†è·å–çš„è¯†åˆ«ç»“æœ:', data);
                    
                    if (data.result) {
                        return data.result;
                    } else {
                        throw new Error('ä»£ç†APIè¿”å›æ•°æ®æ ¼å¼é”™è¯¯');
                    }
                    
                } catch (error) {
                    console.error('é€šè¿‡ä»£ç†è°ƒç”¨Vision APIå¤±è´¥:', error);
                    throw new Error(`å›¾ç‰‡è¯†åˆ«å¤±è´¥: ${error.message}`);
                }
            }

            // å°†Blobè½¬æ¢ä¸ºbase64
            async blobToBase64(blob) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onloadend = () => resolve(reader.result);
                    reader.onerror = reject;
                    reader.readAsDataURL(blob);
                });
            }
        }

        // åˆå§‹åŒ–åº”ç”¨
        const app = new AIPPTGenerator();
        
        // é¡µé¢åŠ è½½æ—¶æ¸…é™¤å¯èƒ½çš„æ—§ç¼“å­˜ï¼Œç¡®ä¿ä½¿ç”¨æœ€æ–°çš„ä»£ç æ¨¡æ¿
        window.addEventListener('load', function() {
            console.log('é¡µé¢åŠ è½½å®Œæˆï¼Œç¯å¢ƒæ£€æµ‹:', app.isLocalEnvironment() ? 'æœ¬åœ°ç¯å¢ƒ' : 'ç”Ÿäº§ç¯å¢ƒ');
            console.log('å½“å‰URL:', window.location.href);
            console.log('ç”¨æˆ·ä»£ç†:', navigator.userAgent);
            
            // æ¸…é™¤å¯èƒ½å½±å“Promptä½¿ç”¨çš„æ—§ç¼“å­˜
            const debuggedPromptData = localStorage.getItem('debuggedPrompt');
            if (debuggedPromptData) {
                try {
                    const promptConfig = JSON.parse(debuggedPromptData);
                    // å¦‚æœè¶…è¿‡5åˆ†é’Ÿï¼Œè‡ªåŠ¨æ¸…é™¤
                    const fiveMinutes = 5 * 60 * 1000;
                    if (Date.now() - promptConfig.timestamp > fiveMinutes) {
                        localStorage.removeItem('debuggedPrompt');
                        console.log('å·²æ¸…é™¤è¿‡æœŸçš„è°ƒè¯•å™¨Promptç¼“å­˜ï¼Œç°åœ¨å°†ä½¿ç”¨ä»£ç ä¸­çš„æœ€æ–°æ¨¡æ¿');
                    }
                } catch (e) {
                    localStorage.removeItem('debuggedPrompt');
                    console.log('å·²æ¸…é™¤æ— æ•ˆçš„è°ƒè¯•å™¨Promptç¼“å­˜');
                }
            }
            
            // æ£€æŸ¥å…³é”®å…ƒç´ æ˜¯å¦å­˜åœ¨
            const generateBtn = document.getElementById('generateBtn');
            const userInput = document.getElementById('userInput');
            const componentOptions = document.querySelectorAll('.component-option');
            
            console.log('å…³é”®å…ƒç´ æ£€æŸ¥:');
            console.log('- ç”ŸæˆæŒ‰é’®:', generateBtn ? 'âœ“' : 'âœ—');
            console.log('- è¾“å…¥æ¡†:', userInput ? 'âœ“' : 'âœ—');
            console.log('- ç»„ä»¶é€‰é¡¹:', componentOptions.length, 'ä¸ª');
            
            console.log('AI PPTç»„ä»¶ç”Ÿæˆå™¨å·²åŠ è½½ï¼Œå°†ä¼˜å…ˆä½¿ç”¨ä»£ç ä¸­çš„Promptæ¨¡æ¿');
        });
    </script>
</body>
</html>
